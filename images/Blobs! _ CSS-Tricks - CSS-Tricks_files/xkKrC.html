<!DOCTYPE html>
<!-- saved from url=(0140)https://codepen.io/hakimel/embed/DzmKrk?default-tab=result&height=418&name=cp_embed_5&pen-title=Blob&slug-hash=xkKrC&theme-id=1&user=hakimel -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width">
<title>CodePen Embed - Blob</title>
<meta name="csrf-param" content="authenticity_token">
<meta name="csrf-token" content="OY9kVVYW8C6Ap252VbJiqaR9WU5vjsBySQSrc791lbXGzSUw1bKVQYwzlxwLo+8OVHkwJ7+nkppCMA5qf3UKEQ==">
<link rel="stylesheet" media="all" href="./embed-5c9d0df4194479e72f3f4195cb70bfc2217587bcd5b1acda570c7aadbea18f9c.css">
<style>
    .hide {
      display: none !important;
    }

    #result-box {
      background: #28282a;
      color: #ffffff;
    }
    .embed-footer,
    .embed-nav {
      background: #28282a;
      
    }
    .embed-nav .code-types a,
    .embed-nav .result-button-list a,
    .action-button {
      color: #ffffff;
      background-color: #424242;
    }
    .embed-nav .code-types a.active,
    .embed-nav .result-button-list a.active,
    .action-button.active {
      background: #212121;
      color: #ffffff;
      box-shadow: inset 0px 3px #ff8a00;
    }
    .embed-nav .logo-wrap .edit-on-codepen {
      color: #a9a9a9;
    }

    .embed-nav svg {
      stroke: #a9a9a9 !important;
    }
  </style>
<link rel="stylesheet" media="all" href="./highcontrast-dark-c9f58c52f642f276610867eb0652eb22d9d88af6dddef0874efd8d911a7938ff.css">
<link rel="stylesheet" href="./maVRwd.css">
<meta name="monetization" content="$ilp.uphold.com/biyqg2MkQKbe">
</head>
<body id="the-body" style="border: 1px solid #39231b; --borderWidth: 1px;" class="codepen-embed-body static results-active">
<nav class="embed-nav group" id="embed-nav">
<ul class="code-types">
<li class="code-type">
<a id="html-link" href="https://codepen.io/hakimel/embed/DzmKrk?default-tab=result&amp;height=418&amp;name=cp_embed_5&amp;pen-title=Blob&amp;slug-hash=xkKrC&amp;theme-id=1&amp;user=hakimel#html-box" role="button" aria-pressed="false">
HTML
</a>
</li>
<li class="code-type">
<a id="css-link" href="https://codepen.io/hakimel/embed/DzmKrk?default-tab=result&amp;height=418&amp;name=cp_embed_5&amp;pen-title=Blob&amp;slug-hash=xkKrC&amp;theme-id=1&amp;user=hakimel#css-box" role="button" aria-pressed="false">
CSS
</a>
</li>
<li class="code-type">
<a id="js-link" href="https://codepen.io/hakimel/embed/DzmKrk?default-tab=result&amp;height=418&amp;name=cp_embed_5&amp;pen-title=Blob&amp;slug-hash=xkKrC&amp;theme-id=1&amp;user=hakimel#js-box" role="button" aria-pressed="false">
JS
</a>
</li>
</ul>
<ul class="result-button-list">
<li class="results results-type">
<a id="result-link" href="https://codepen.io/hakimel/embed/DzmKrk?default-tab=result&amp;height=418&amp;name=cp_embed_5&amp;pen-title=Blob&amp;slug-hash=xkKrC&amp;theme-id=1&amp;user=hakimel#result-box" class="active" aria-pressed="true" role="button">
Result
</a>
</li>
<li>
<a href="https://codepen.io/hakimel/embed/DzmKrk?default-tab=result&amp;height=418&amp;name=cp_embed_5&amp;pen-title=Blob&amp;slug-hash=xkKrC&amp;theme-id=1&amp;user=hakimel#resources-link" id="skip-results-iframe-link">Skip Results Iframe</a>
</li>
</ul>
<div class="logo-wrap" id="edit-area">
<a class="edit-on-codepen" target="_blank" rel="noopener" href="https://codepen.io/hakimel/pen/DzmKrk" title="Edit on CodePen">
<div class="large-logo">
<span id="edit-on-text" class="open-on">EDIT ON</span>
<svg id="embed-codepen-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 138 26" fill="none" stroke="#000" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="CodePen">
<path d="M80 6h-9v14h9m34-14h-9v14h9m-3-7h-6m-28 0h-6m51 7V6l11 14V6M22 16.7L33 24l11-7.3V9.3L33 2 22 9.3v7.4zm22 0L33 9.3l-11 7.4m0-7.4l11 7.3 11-7.3M33 2v7.3m0 7.4V24m55-10h6c2.2 0 4-1.8 4-4s-1.8-4-4-4h-6v14M15 8c-1.3-1.3-3-2-5-2-4 0-7 3-7 7s3 7 7 7c2 0 3.7-.8 5-2m49-5c0 4-3 7-7 7h-5V6h5c4 0 7 3 7 7z"></path>
</svg>
</div>
<div class="box-logo">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="20 0 26 26" fill="none" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.3" role="img" aria-label="Edit on CodePen">
<path id="icon-codepen-box" d="M22 16.7L33 24l11-7.3V9.3L33 2 22 9.3v7.4zm22 0L33 9.3l-11 7.4m0-7.4l11 7.3 11-7.3M33 2v7.3m0 7.4V24"></path>
</svg>
</div>
</a>
</div>
</nav>
<div id="output" data-border-style="thin" data-header="true">
<div id="html-box" class="code-wrap code-box box " role="region" aria-label="HTML">
<pre tabindex="0"><code data-lang="htmlmixed" id="actual-html-code" class=" cm-s-default"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">p</span><span class="cm-tag cm-bracket">&gt;</span>Double click to split. <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">a</span> <span class="cm-attribute">id</span>=<span class="cm-string">"keyboardUp"</span> <span class="cm-attribute">href</span>=<span class="cm-string">"#"</span><span class="cm-tag cm-bracket">&gt;</span>Increase<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">a</span><span class="cm-tag cm-bracket">&gt;</span> / <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">a</span> <span class="cm-attribute">id</span>=<span class="cm-string">"keyboardDown"</span> <span class="cm-attribute">href</span>=<span class="cm-string">"#"</span><span class="cm-tag cm-bracket">&gt;</span>decrease<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">a</span><span class="cm-tag cm-bracket">&gt;</span> size or <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">a</span> <span class="cm-attribute">id</span>=<span class="cm-string">"keyboardLeft"</span> <span class="cm-attribute">href</span>=<span class="cm-string">"#"</span><span class="cm-tag cm-bracket">&gt;</span>Previous<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">a</span><span class="cm-tag cm-bracket">&gt;</span> / <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">a</span> <span class="cm-attribute">id</span>=<span class="cm-string">"keyboardRight"</span> <span class="cm-attribute">href</span>=<span class="cm-string">"#"</span><span class="cm-tag cm-bracket">&gt;</span>Next<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">a</span><span class="cm-tag cm-bracket">&gt;</span> skin.<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">p</span><span class="cm-tag cm-bracket">&gt;</span>
<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">canvas</span> <span class="cm-attribute">id</span>=<span class="cm-string">'world'</span><span class="cm-tag cm-bracket">&gt;</span><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">canvas</span><span class="cm-tag cm-bracket">&gt;</span></code></pre>
</div>
<div id="css-box" class="code-wrap code-box box " role="region" aria-label="CSS">
<pre tabindex="0"><code data-lang="css" id="actual-css-code" class=" cm-s-default"><span class="cm-tag">body</span> {
    <span class="cm-property">background-color</span>: <span class="cm-atom">#333333</span>;
    <span class="cm-property">padding</span>: <span class="cm-number">0</span>;
    <span class="cm-property">margin</span>: <span class="cm-number">0</span>;
    <span class="cm-property">overflow</span>: <span class="cm-atom">hidden</span>;
}
<span class="cm-tag">p</span> {
    <span class="cm-property">position</span>: <span class="cm-atom">absolute</span>;
    <span class="cm-property">z-index</span>: <span class="cm-number">99</span>;
    <span class="cm-property">color</span>: <span class="cm-atom">#cccccc</span>;
    <span class="cm-property">margin</span>: <span class="cm-number">2px</span>;
    <span class="cm-property">padding</span>: <span class="cm-number">0</span>;
    <span class="cm-property">font-family</span>: <span class="cm-variable">Arial</span>;
    <span class="cm-property">font-size</span>: <span class="cm-number">10px</span>;
}
<span class="cm-tag">a</span> { 
    <span class="cm-property">color</span>: <span class="cm-atom">#f4f4f4</span>;
    <span class="cm-property">font-weight</span>: <span class="cm-atom">bold</span>;
}</code></pre>
</div>
<div id="js-box" class="code-wrap code-box box " role="region" aria-label="JS">
<pre tabindex="0"><code data-lang="javascript" id="actual-js-code" class=" cm-s-default"><span class="cm-comment">/**</span>
<span class="cm-comment">  * https://lab.hakim.se/blob/03/</span>
<span class="cm-comment">  */</span>
<span class="cm-variable">BlobWorld</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-keyword">function</span>() {
  
  <span class="cm-keyword">var</span> <span class="cm-def">SCREEN_WIDTH</span> <span class="cm-operator">=</span> <span class="cm-variable">window</span>.<span class="cm-property">innerWidth</span>;
  <span class="cm-keyword">var</span> <span class="cm-def">SCREEN_HEIGHT</span> <span class="cm-operator">=</span> <span class="cm-variable">window</span>.<span class="cm-property">innerHeight</span>;
  
  <span class="cm-keyword">var</span> <span class="cm-def">canvas</span>;
  <span class="cm-keyword">var</span> <span class="cm-def">context</span>;
  <span class="cm-keyword">var</span> <span class="cm-def">blobs</span> <span class="cm-operator">=</span> [];
  
  <span class="cm-keyword">var</span> <span class="cm-def">dragBlob</span>;
  
  <span class="cm-keyword">var</span> <span class="cm-def">screenX</span> <span class="cm-operator">=</span> <span class="cm-variable">window</span>.<span class="cm-property">screenX</span>;
  <span class="cm-keyword">var</span> <span class="cm-def">screenY</span> <span class="cm-operator">=</span> <span class="cm-variable">window</span>.<span class="cm-property">screenY</span>;
  
  <span class="cm-keyword">var</span> <span class="cm-def">mouseX</span> <span class="cm-operator">=</span> (<span class="cm-variable">window</span>.<span class="cm-property">innerWidth</span> <span class="cm-operator">-</span> <span class="cm-variable-2">SCREEN_WIDTH</span>);
  <span class="cm-keyword">var</span> <span class="cm-def">mouseY</span> <span class="cm-operator">=</span> (<span class="cm-variable">window</span>.<span class="cm-property">innerHeight</span> <span class="cm-operator">-</span> <span class="cm-variable-2">SCREEN_HEIGHT</span>);
  <span class="cm-keyword">var</span> <span class="cm-def">mouseIsDown</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;
  <span class="cm-keyword">var</span> <span class="cm-def">mouseDownOffset</span> <span class="cm-operator">=</span> { <span class="cm-property">x</span>: <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-number">0</span> };
  
  <span class="cm-comment">// The bounds of the world</span>
  <span class="cm-keyword">var</span> <span class="cm-def">worldRect</span> <span class="cm-operator">=</span> { <span class="cm-property">x</span>: <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-number">0</span>, <span class="cm-property">width</span>: <span class="cm-number">0</span>, <span class="cm-property">height</span>: <span class="cm-number">0</span> };
  
  <span class="cm-comment">// The world gravity, applied to all blobs</span>
  <span class="cm-keyword">var</span> <span class="cm-def">gravity</span> <span class="cm-operator">=</span> { <span class="cm-property">x</span>: <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-number">1.2</span> };
  
  <span class="cm-comment">// A pair of blobs that should be merged</span>
  <span class="cm-keyword">var</span> <span class="cm-def">mergeQueue</span> <span class="cm-operator">=</span> { <span class="cm-property">blobA</span>: <span class="cm-operator">-</span><span class="cm-number">1</span>, <span class="cm-property">blobB</span>: <span class="cm-operator">-</span><span class="cm-number">1</span> };
  
  <span class="cm-keyword">var</span> <span class="cm-def">skinIndex</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;
  <span class="cm-keyword">var</span> <span class="cm-def">skins</span> <span class="cm-operator">=</span> [
       { <span class="cm-property">fillStyle</span>: <span class="cm-string">'rgba(0,200,250,1.0)'</span>, <span class="cm-property">strokeStyle</span>: <span class="cm-string">'#ffffff'</span>, <span class="cm-property">lineWidth</span>: <span class="cm-number">5</span>, <span class="cm-property">debug</span>: <span class="cm-atom">false</span> },
       { <span class="cm-property">fillStyle</span>: <span class="cm-string">''</span>, <span class="cm-property">strokeStyle</span>: <span class="cm-string">''</span>, <span class="cm-property">lineWidth</span>: <span class="cm-number">0</span>, <span class="cm-property">debug</span>: <span class="cm-atom">true</span> },
     { <span class="cm-property">fillStyle</span>: <span class="cm-string">'rgba(0,0,0,0.1)'</span>, <span class="cm-property">strokeStyle</span>: <span class="cm-string">'rgba(255,255,255,1.0)'</span>, <span class="cm-property">lineWidth</span>: <span class="cm-number">6</span>, <span class="cm-property">debug</span>: <span class="cm-atom">false</span> },
       { <span class="cm-property">fillStyle</span>: <span class="cm-string">'rgba(0,230,110,1.0)'</span>, <span class="cm-property">strokeStyle</span>: <span class="cm-string">'rgba(0,0,0,1.0)'</span>, <span class="cm-property">lineWidth</span>: <span class="cm-number">2</span>, <span class="cm-property">debug</span>: <span class="cm-atom">false</span> },
       { <span class="cm-property">fillStyle</span>: <span class="cm-string">'rgba(255,255,0,1.0)'</span>, <span class="cm-property">strokeStyle</span>: <span class="cm-string">'rgba(0,0,0,1.0)'</span>, <span class="cm-property">lineWidth</span>: <span class="cm-number">4</span>, <span class="cm-property">debug</span>: <span class="cm-atom">false</span> },
       { <span class="cm-property">fillStyle</span>: <span class="cm-string">'rgba(255,255,255,1.0)'</span>, <span class="cm-property">strokeStyle</span>: <span class="cm-string">'rgba(0,0,0,1.0)'</span>, <span class="cm-property">lineWidth</span>: <span class="cm-number">4</span>, <span class="cm-property">debug</span>: <span class="cm-atom">false</span> }
  ];
  
  <span class="cm-keyword">this</span>.<span class="cm-property">init</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>() {
    
    <span class="cm-variable-2">canvas</span> <span class="cm-operator">=</span> <span class="cm-variable">document</span>.<span class="cm-property">getElementById</span>( <span class="cm-string">'world'</span> );
    
    <span class="cm-keyword">if</span> (<span class="cm-variable-2">canvas</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable-2">canvas</span>.<span class="cm-property">getContext</span>) {
      <span class="cm-variable-2">context</span> <span class="cm-operator">=</span> <span class="cm-variable-2">canvas</span>.<span class="cm-property">getContext</span>(<span class="cm-string">'2d'</span>);
      
      <span class="cm-comment">// Register event listeners</span>
      <span class="cm-variable">window</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'mousemove'</span>, <span class="cm-variable">documentMouseMoveHandler</span>, <span class="cm-atom">false</span>);
      <span class="cm-variable-2">canvas</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'mousedown'</span>, <span class="cm-variable">documentMouseDownHandler</span>, <span class="cm-atom">false</span>);
      <span class="cm-variable-2">canvas</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'dblclick'</span>, <span class="cm-variable">documentDoubleClickHandler</span>, <span class="cm-atom">false</span>);
      <span class="cm-variable">window</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'mouseup'</span>, <span class="cm-variable">documentMouseUpHandler</span>, <span class="cm-atom">false</span>);
      <span class="cm-variable">document</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'touchstart'</span>, <span class="cm-variable">documentTouchStartHandler</span>, <span class="cm-atom">false</span>);
      <span class="cm-variable">document</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'touchmove'</span>, <span class="cm-variable">documentTouchMoveHandler</span>, <span class="cm-atom">false</span>);
      <span class="cm-variable">document</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'touchend'</span>, <span class="cm-variable">documentTouchEndHandler</span>, <span class="cm-atom">false</span>);
      <span class="cm-variable">document</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'keydown'</span>, <span class="cm-variable">documentKeyDownHandler</span>, <span class="cm-atom">false</span>);
      <span class="cm-variable">window</span>.<span class="cm-property">addEventListener</span>(<span class="cm-string">'resize'</span>, <span class="cm-variable">windowResizeHandler</span>, <span class="cm-atom">false</span>);
      
      <span class="cm-variable">document</span>.<span class="cm-property">getElementById</span>( <span class="cm-string">'keyboardUp'</span> ).<span class="cm-property">addEventListener</span>(<span class="cm-string">'click'</span>, <span class="cm-variable">keyboardUpHandler</span>, <span class="cm-atom">false</span>);
      <span class="cm-variable">document</span>.<span class="cm-property">getElementById</span>( <span class="cm-string">'keyboardDown'</span> ).<span class="cm-property">addEventListener</span>(<span class="cm-string">'click'</span>, <span class="cm-variable">keyboardDownHandler</span>, <span class="cm-atom">false</span>);
      <span class="cm-variable">document</span>.<span class="cm-property">getElementById</span>( <span class="cm-string">'keyboardLeft'</span> ).<span class="cm-property">addEventListener</span>(<span class="cm-string">'click'</span>, <span class="cm-variable">keyboardLeftHandler</span>, <span class="cm-atom">false</span>);
      <span class="cm-variable">document</span>.<span class="cm-property">getElementById</span>( <span class="cm-string">'keyboardRight'</span> ).<span class="cm-property">addEventListener</span>(<span class="cm-string">'click'</span>, <span class="cm-variable">keyboardRightHandler</span>, <span class="cm-atom">false</span>);
      
      <span class="cm-variable">createBlob</span>( { <span class="cm-property">x</span>: <span class="cm-variable-2">SCREEN_WIDTH</span><span class="cm-operator">*</span><span class="cm-number">0.5</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">SCREEN_HEIGHT</span><span class="cm-operator">*</span><span class="cm-number">0.1</span> } );
      
      <span class="cm-variable">windowResizeHandler</span>();
      
      <span class="cm-variable">setInterval</span>( <span class="cm-variable">loop</span>, <span class="cm-number">1000</span> <span class="cm-operator">/</span> <span class="cm-number">60</span> );
    }
  };
  
  <span class="cm-keyword">function</span> <span class="cm-def">createBlob</span>( <span class="cm-def">position</span> ) {
    <span class="cm-keyword">var</span> <span class="cm-def">blob</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Blob</span>();
    
    <span class="cm-variable-2">blob</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable-2">position</span>.<span class="cm-property">x</span>;
    <span class="cm-variable-2">blob</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable-2">position</span>.<span class="cm-property">y</span>;
    
    <span class="cm-variable-2">blob</span>.<span class="cm-property">generateNodes</span>();
    
    <span class="cm-variable-2">blobs</span>.<span class="cm-property">push</span>( <span class="cm-variable-2">blob</span> );
  }
  
  <span class="cm-keyword">function</span> <span class="cm-def">splitBlob</span>( <span class="cm-def">blob</span> ) {
    <span class="cm-keyword">if</span>( <span class="cm-variable-2">blob</span>.<span class="cm-property">quality</span> <span class="cm-operator">&gt;</span> <span class="cm-number">8</span> ) {
      <span class="cm-variable-2">blobs</span>.<span class="cm-property">push</span>( <span class="cm-variable-2">blob</span>.<span class="cm-property">split</span>() );
    }
  }
  
  <span class="cm-keyword">function</span> <span class="cm-def">mergeBlobs</span>( <span class="cm-def">blobA</span>, <span class="cm-def">blobB</span> ) {
    <span class="cm-keyword">var</span> <span class="cm-def">t</span> <span class="cm-operator">=</span> <span class="cm-variable">getTime</span>();
    
    <span class="cm-keyword">if</span>( <span class="cm-operator">!</span><span class="cm-variable-2">blobs</span>[<span class="cm-variable-2">blobA</span>] <span class="cm-operator">||</span> <span class="cm-operator">!</span><span class="cm-variable-2">blobs</span>[<span class="cm-variable-2">blobB</span>] ) {
      <span class="cm-keyword">return</span>;
    }
    
    <span class="cm-keyword">if</span>( <span class="cm-variable-2">t</span> <span class="cm-operator">-</span> <span class="cm-variable-2">blobs</span>[<span class="cm-variable-2">blobA</span>].<span class="cm-property">lastSplitTime</span> <span class="cm-operator">&gt;</span> <span class="cm-number">500</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable-2">t</span> <span class="cm-operator">-</span> <span class="cm-variable-2">blobs</span>[<span class="cm-variable-2">blobB</span>].<span class="cm-property">lastSplitTime</span> <span class="cm-operator">&gt;</span> <span class="cm-number">500</span> ) {
      <span class="cm-comment">// Merge blobB with blobA</span>
      <span class="cm-variable-2">blobs</span>[<span class="cm-variable-2">blobA</span>].<span class="cm-property">merge</span>( <span class="cm-variable-2">blobs</span>[<span class="cm-variable-2">blobB</span>] );
      
      <span class="cm-comment">// Remove blobB since blobA will take over its body</span>
      <span class="cm-variable-2">blobs</span>.<span class="cm-property">splice</span>( <span class="cm-variable-2">blobB</span>, <span class="cm-number">1</span> );
    }
  }

  <span class="cm-keyword">function</span> <span class="cm-def">documentMouseMoveHandler</span>(<span class="cm-def">event</span>) {
    <span class="cm-variable-2">mouseX</span> <span class="cm-operator">=</span> <span class="cm-variable-2">event</span>.<span class="cm-property">clientX</span> <span class="cm-operator">-</span> (<span class="cm-variable">window</span>.<span class="cm-property">innerWidth</span> <span class="cm-operator">-</span> <span class="cm-variable-2">SCREEN_WIDTH</span>) <span class="cm-operator">*</span> <span class="cm-number">.5</span>;
    <span class="cm-variable-2">mouseY</span> <span class="cm-operator">=</span> <span class="cm-variable-2">event</span>.<span class="cm-property">clientY</span> <span class="cm-operator">-</span> (<span class="cm-variable">window</span>.<span class="cm-property">innerHeight</span> <span class="cm-operator">-</span> <span class="cm-variable-2">SCREEN_HEIGHT</span>) <span class="cm-operator">*</span> <span class="cm-number">.5</span>;
  }
  
  <span class="cm-keyword">function</span> <span class="cm-def">documentMouseDownHandler</span>(<span class="cm-def">event</span>) {
    <span class="cm-variable-2">event</span>.<span class="cm-property">preventDefault</span>();
    
    <span class="cm-variable-2">mouseIsDown</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;
    
    <span class="cm-variable-2">dragBlob</span> <span class="cm-operator">=</span> <span class="cm-variable-2">blobs</span>[ <span class="cm-variable">findClosestBody</span>( <span class="cm-variable-2">blobs</span>, { <span class="cm-property">x</span>: <span class="cm-variable-2">mouseX</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">mouseY</span> } ) ];
    <span class="cm-keyword">var</span> <span class="cm-def">closestNodeIndex</span> <span class="cm-operator">=</span> <span class="cm-variable">findClosestBody</span>( <span class="cm-variable-2">dragBlob</span>.<span class="cm-property">nodes</span>, { <span class="cm-property">x</span>: <span class="cm-variable-2">mouseX</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">mouseY</span> } );
    <span class="cm-variable-2">dragBlob</span>.<span class="cm-property">dragNodeIndex</span> <span class="cm-operator">=</span> <span class="cm-variable-2">closestNodeIndex</span>;
    
    <span class="cm-variable-2">mouseDownOffset</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-number">100</span>;
  }
  
  <span class="cm-keyword">function</span> <span class="cm-def">documentMouseUpHandler</span>(<span class="cm-def">event</span>) {
    <span class="cm-variable-2">mouseIsDown</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;
    
    <span class="cm-keyword">if</span>( <span class="cm-variable-2">dragBlob</span> ) {
      <span class="cm-variable-2">dragBlob</span>.<span class="cm-property">dragNodeIndex</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;
      <span class="cm-variable-2">dragBlob</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;
    }
  }
  
  <span class="cm-keyword">function</span> <span class="cm-def">documentTouchStartHandler</span>(<span class="cm-def">event</span>) {
    <span class="cm-keyword">if</span>(<span class="cm-variable-2">event</span>.<span class="cm-property">touches</span>.<span class="cm-property">length</span> <span class="cm-operator">==</span> <span class="cm-number">1</span>) {
      <span class="cm-variable-2">event</span>.<span class="cm-property">preventDefault</span>();
      
      <span class="cm-variable-2">mouseIsDown</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;
      
      <span class="cm-variable-2">mouseX</span> <span class="cm-operator">=</span> <span class="cm-variable-2">event</span>.<span class="cm-property">touches</span>[<span class="cm-number">0</span>].<span class="cm-property">pageX</span> <span class="cm-operator">-</span> (<span class="cm-variable">window</span>.<span class="cm-property">innerWidth</span> <span class="cm-operator">-</span> <span class="cm-variable-2">SCREEN_WIDTH</span>) <span class="cm-operator">*</span> <span class="cm-number">.5</span>;
      <span class="cm-variable-2">mouseY</span> <span class="cm-operator">=</span> <span class="cm-variable-2">event</span>.<span class="cm-property">touches</span>[<span class="cm-number">0</span>].<span class="cm-property">pageY</span> <span class="cm-operator">-</span> (<span class="cm-variable">window</span>.<span class="cm-property">innerHeight</span> <span class="cm-operator">-</span> <span class="cm-variable-2">SCREEN_HEIGHT</span>) <span class="cm-operator">*</span> <span class="cm-number">.5</span>;
      
      <span class="cm-variable-2">dragBlob</span> <span class="cm-operator">=</span> <span class="cm-variable-2">blobs</span>[ <span class="cm-variable">findClosestBody</span>( <span class="cm-variable-2">blobs</span>, { <span class="cm-property">x</span>: <span class="cm-variable-2">mouseX</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">mouseY</span> } ) ];
      <span class="cm-keyword">var</span> <span class="cm-def">closestNodeIndex</span> <span class="cm-operator">=</span> <span class="cm-variable">findClosestBody</span>( <span class="cm-variable-2">dragBlob</span>.<span class="cm-property">nodes</span>, { <span class="cm-property">x</span>: <span class="cm-variable-2">mouseX</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">mouseY</span> } );
      <span class="cm-variable-2">dragBlob</span>.<span class="cm-property">dragNodeIndex</span> <span class="cm-operator">=</span> <span class="cm-variable-2">closestNodeIndex</span>;
      
      <span class="cm-variable-2">mouseDownOffset</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-number">100</span>;
    }
  }
  
  <span class="cm-keyword">function</span> <span class="cm-def">documentTouchMoveHandler</span>(<span class="cm-def">event</span>) {
    <span class="cm-keyword">if</span>(<span class="cm-variable-2">event</span>.<span class="cm-property">touches</span>.<span class="cm-property">length</span> <span class="cm-operator">==</span> <span class="cm-number">1</span>) {
      <span class="cm-variable-2">event</span>.<span class="cm-property">preventDefault</span>();

      <span class="cm-variable-2">mouseX</span> <span class="cm-operator">=</span> <span class="cm-variable-2">event</span>.<span class="cm-property">touches</span>[<span class="cm-number">0</span>].<span class="cm-property">pageX</span> <span class="cm-operator">-</span> (<span class="cm-variable">window</span>.<span class="cm-property">innerWidth</span> <span class="cm-operator">-</span> <span class="cm-variable-2">SCREEN_WIDTH</span>) <span class="cm-operator">*</span> <span class="cm-number">.5</span>;
      <span class="cm-variable-2">mouseY</span> <span class="cm-operator">=</span> <span class="cm-variable-2">event</span>.<span class="cm-property">touches</span>[<span class="cm-number">0</span>].<span class="cm-property">pageY</span> <span class="cm-operator">-</span> (<span class="cm-variable">window</span>.<span class="cm-property">innerHeight</span> <span class="cm-operator">-</span> <span class="cm-variable-2">SCREEN_HEIGHT</span>) <span class="cm-operator">*</span> <span class="cm-number">.5</span>;
    }
  }
  
  <span class="cm-keyword">function</span> <span class="cm-def">documentTouchEndHandler</span>(<span class="cm-def">event</span>) {
    <span class="cm-variable-2">mouseIsDown</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>;
    
    <span class="cm-keyword">if</span>( <span class="cm-variable-2">dragBlob</span> ) {
      <span class="cm-variable-2">dragBlob</span>.<span class="cm-property">dragNodeIndex</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;
      <span class="cm-variable-2">dragBlob</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;
    }
  }
  
  <span class="cm-keyword">function</span> <span class="cm-def">documentDoubleClickHandler</span>(<span class="cm-def">event</span>) {
    <span class="cm-keyword">var</span> <span class="cm-def">mouse</span> <span class="cm-operator">=</span> { <span class="cm-property">x</span>: <span class="cm-variable-2">mouseX</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">mouseY</span> };
    
    <span class="cm-keyword">var</span> <span class="cm-def">blob</span> <span class="cm-operator">=</span> <span class="cm-variable-2">blobs</span>[<span class="cm-variable">findClosestBody</span>( <span class="cm-variable-2">blobs</span>, <span class="cm-variable-2">mouse</span> )];
    
    <span class="cm-keyword">if</span>( <span class="cm-variable">distanceBetween</span>( <span class="cm-variable-2">blob</span>.<span class="cm-property">position</span>, <span class="cm-variable-2">mouse</span> ) <span class="cm-operator">&lt;</span> <span class="cm-variable-2">blob</span>.<span class="cm-property">radius</span> <span class="cm-operator">+</span> <span class="cm-number">30</span> ) {
      <span class="cm-variable-2">splitBlob</span>( <span class="cm-variable-2">blob</span> );
    }
  }
  
  <span class="cm-keyword">function</span> <span class="cm-def">documentKeyDownHandler</span>(<span class="cm-def">event</span>) {
    <span class="cm-keyword">switch</span>( <span class="cm-variable-2">event</span>.<span class="cm-property">keyCode</span> ) {
      <span class="cm-keyword">case</span> <span class="cm-number">40</span>:
        <span class="cm-variable">changeBlobRadius</span>( <span class="cm-operator">-</span><span class="cm-number">10</span> );
        <span class="cm-variable-2">event</span>.<span class="cm-property">preventDefault</span>();
        <span class="cm-keyword">break</span>;
      <span class="cm-keyword">case</span> <span class="cm-number">38</span>:
        <span class="cm-variable">changeBlobRadius</span>( <span class="cm-number">10</span> );
        <span class="cm-variable-2">event</span>.<span class="cm-property">preventDefault</span>();
        <span class="cm-keyword">break</span>;
      <span class="cm-keyword">case</span> <span class="cm-number">37</span>:
        <span class="cm-variable">changeSkin</span>( <span class="cm-operator">-</span><span class="cm-number">1</span> );
        <span class="cm-variable-2">event</span>.<span class="cm-property">preventDefault</span>();
        <span class="cm-keyword">break</span>;
      <span class="cm-keyword">case</span> <span class="cm-number">39</span>:
        <span class="cm-variable">changeSkin</span>( <span class="cm-number">1</span> );
        <span class="cm-variable-2">event</span>.<span class="cm-property">preventDefault</span>();
        <span class="cm-keyword">break</span>;
    }
  }
  
  <span class="cm-keyword">function</span> <span class="cm-def">keyboardUpHandler</span>(<span class="cm-def">event</span>) {
    <span class="cm-variable-2">event</span>.<span class="cm-property">preventDefault</span>();
    <span class="cm-variable">changeBlobRadius</span>( <span class="cm-number">20</span> );
    }
  
  <span class="cm-keyword">function</span> <span class="cm-def">keyboardDownHandler</span>(<span class="cm-def">event</span>) {
    <span class="cm-variable-2">event</span>.<span class="cm-property">preventDefault</span>();
    <span class="cm-variable">changeBlobRadius</span>( <span class="cm-operator">-</span><span class="cm-number">20</span> );
  }
  
  <span class="cm-keyword">function</span> <span class="cm-def">keyboardLeftHandler</span>(<span class="cm-def">event</span>) {
    <span class="cm-variable-2">event</span>.<span class="cm-property">preventDefault</span>();
    <span class="cm-variable">changeSkin</span>( <span class="cm-operator">-</span><span class="cm-number">1</span> );
  }
  
  <span class="cm-keyword">function</span> <span class="cm-def">keyboardRightHandler</span>(<span class="cm-def">event</span>) {
    <span class="cm-variable-2">event</span>.<span class="cm-property">preventDefault</span>();
    <span class="cm-variable">changeSkin</span>( <span class="cm-number">1</span> );
  }
  
  <span class="cm-keyword">function</span> <span class="cm-def">changeSkin</span>( <span class="cm-def">offset</span> ) {
    <span class="cm-variable-2">skinIndex</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">offset</span>;
    <span class="cm-variable-2">skinIndex</span> <span class="cm-operator">=</span> <span class="cm-variable-2">skinIndex</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span> <span class="cm-operator">?</span> <span class="cm-variable-2">skins</span>.<span class="cm-property">length</span><span class="cm-operator">-</span><span class="cm-number">1</span> : <span class="cm-variable-2">skinIndex</span>;
    <span class="cm-variable-2">skinIndex</span> <span class="cm-operator">=</span> <span class="cm-variable-2">skinIndex</span> <span class="cm-operator">&gt;</span> <span class="cm-variable-2">skins</span>.<span class="cm-property">length</span><span class="cm-operator">-</span><span class="cm-number">1</span> <span class="cm-operator">?</span> <span class="cm-number">0</span> : <span class="cm-variable-2">skinIndex</span>;
  }
  
  <span class="cm-keyword">function</span> <span class="cm-def">changeBlobRadius</span>( <span class="cm-def">offset</span> ) {
    <span class="cm-keyword">for</span>( <span class="cm-keyword">var</span> <span class="cm-def">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>, <span class="cm-def">len</span> <span class="cm-operator">=</span> <span class="cm-variable-2">blobs</span>.<span class="cm-property">length</span>; <span class="cm-variable-2">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">len</span>; <span class="cm-variable-2">i</span><span class="cm-operator">++</span> ) {
      <span class="cm-variable-2">blob</span> <span class="cm-operator">=</span> <span class="cm-variable-2">blobs</span>[<span class="cm-variable-2">i</span>];
      
      <span class="cm-keyword">var</span> <span class="cm-def">oldRadius</span> <span class="cm-operator">=</span> <span class="cm-variable-2">blob</span>.<span class="cm-property">radius</span>;
      
      <span class="cm-variable-2">blob</span>.<span class="cm-property">radius</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">offset</span>;
      <span class="cm-variable-2">blob</span>.<span class="cm-property">radius</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">max</span>( <span class="cm-number">40</span>, <span class="cm-variable">Math</span>.<span class="cm-property">min</span>( <span class="cm-variable-2">blob</span>.<span class="cm-property">radius</span>, <span class="cm-number">280</span> ) );
      
      <span class="cm-keyword">if</span>( <span class="cm-variable-2">blob</span>.<span class="cm-property">radius</span> <span class="cm-operator">!=</span> <span class="cm-variable-2">oldRadius</span> ) {
        <span class="cm-variable-2">blob</span>.<span class="cm-property">updateNormals</span>();
      }
    }
  }
  
  <span class="cm-keyword">function</span> <span class="cm-def">findClosestBody</span>( <span class="cm-def">bodies</span>, <span class="cm-def">position</span> ) {
    <span class="cm-keyword">var</span> <span class="cm-def">closestDistance</span> <span class="cm-operator">=</span> <span class="cm-number">9999</span>;
    <span class="cm-keyword">var</span> <span class="cm-def">currentDistance</span> <span class="cm-operator">=</span> <span class="cm-number">9999</span>;
    <span class="cm-keyword">var</span> <span class="cm-def">closestIndex</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;
    
    <span class="cm-keyword">for</span>( <span class="cm-keyword">var</span> <span class="cm-def">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>, <span class="cm-def">len</span> <span class="cm-operator">=</span> <span class="cm-variable-2">bodies</span>.<span class="cm-property">length</span>; <span class="cm-variable-2">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">len</span>; <span class="cm-variable-2">i</span><span class="cm-operator">++</span> ) {
      <span class="cm-keyword">var</span> <span class="cm-def">body</span> <span class="cm-operator">=</span> <span class="cm-variable-2">bodies</span>[<span class="cm-variable-2">i</span>];
      
      <span class="cm-variable-2">currentDistance</span> <span class="cm-operator">=</span> <span class="cm-variable">distanceBetween</span>( <span class="cm-variable-2">body</span>.<span class="cm-property">position</span>, { <span class="cm-property">x</span>: <span class="cm-variable-2">position</span>.<span class="cm-property">x</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">position</span>.<span class="cm-property">y</span> } );
      
      <span class="cm-keyword">if</span>( <span class="cm-variable-2">currentDistance</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">closestDistance</span> ) {
        <span class="cm-variable-2">closestDistance</span> <span class="cm-operator">=</span> <span class="cm-variable-2">currentDistance</span>;
        <span class="cm-variable-2">closestIndex</span> <span class="cm-operator">=</span> <span class="cm-variable-2">i</span>;
      }
    }
    
    <span class="cm-keyword">return</span> <span class="cm-variable-2">closestIndex</span>;
  }
  
  <span class="cm-keyword">function</span> <span class="cm-def">windowResizeHandler</span>() {
    <span class="cm-variable-2">SCREEN_WIDTH</span> <span class="cm-operator">=</span> <span class="cm-variable">window</span>.<span class="cm-property">innerWidth</span>;
    <span class="cm-variable-2">SCREEN_HEIGHT</span> <span class="cm-operator">=</span> <span class="cm-variable">window</span>.<span class="cm-property">innerHeight</span>;
    
    <span class="cm-variable-2">canvas</span>.<span class="cm-property">width</span> <span class="cm-operator">=</span> <span class="cm-variable-2">SCREEN_WIDTH</span>;
    <span class="cm-variable-2">canvas</span>.<span class="cm-property">height</span> <span class="cm-operator">=</span> <span class="cm-variable-2">SCREEN_HEIGHT</span>;
    
    <span class="cm-variable-2">worldRect</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>;
    <span class="cm-variable-2">worldRect</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-number">3</span>;
    <span class="cm-variable-2">worldRect</span>.<span class="cm-property">width</span> <span class="cm-operator">=</span> <span class="cm-variable-2">SCREEN_WIDTH</span><span class="cm-operator">-</span><span class="cm-number">6</span>;
    <span class="cm-variable-2">worldRect</span>.<span class="cm-property">height</span> <span class="cm-operator">=</span> <span class="cm-variable-2">SCREEN_HEIGHT</span><span class="cm-operator">-</span><span class="cm-number">6</span>;
  }

  <span class="cm-keyword">function</span> <span class="cm-def">loop</span>() {
    
    <span class="cm-keyword">var</span> <span class="cm-def">skin</span> <span class="cm-operator">=</span> <span class="cm-variable-2">skins</span>[<span class="cm-variable-2">skinIndex</span>];
    
    <span class="cm-comment">// The area around the dirty region to include in the clear</span>
    <span class="cm-keyword">var</span> <span class="cm-def">dirtySpread</span> <span class="cm-operator">=</span> <span class="cm-number">80</span>;
    
    <span class="cm-keyword">var</span> <span class="cm-def">u1</span>, <span class="cm-def">u2</span>, <span class="cm-def">ulen</span>, <span class="cm-def">blob</span>;
    
    <span class="cm-comment">// Clear the dirty rects of all blobs</span>
    <span class="cm-keyword">for</span>( <span class="cm-variable-2">u1</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>, <span class="cm-variable-2">ulen</span> <span class="cm-operator">=</span> <span class="cm-variable-2">blobs</span>.<span class="cm-property">length</span>; <span class="cm-variable-2">u1</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">ulen</span>; <span class="cm-variable-2">u1</span><span class="cm-operator">++</span> ) {
      <span class="cm-variable-2">blob</span> <span class="cm-operator">=</span> <span class="cm-variable-2">blobs</span>[<span class="cm-variable-2">u1</span>];
      
      <span class="cm-comment">// Clear all pixels in the dirty region</span>
      <span class="cm-variable-2">context</span>.<span class="cm-property">clearRect</span>(<span class="cm-variable-2">blob</span>.<span class="cm-property">dirtyRegion</span>.<span class="cm-property">left</span><span class="cm-operator">-</span><span class="cm-variable-2">dirtySpread</span>,<span class="cm-variable-2">blob</span>.<span class="cm-property">dirtyRegion</span>.<span class="cm-property">top</span><span class="cm-operator">-</span><span class="cm-variable-2">dirtySpread</span>,<span class="cm-variable-2">blob</span>.<span class="cm-property">dirtyRegion</span>.<span class="cm-property">right</span><span class="cm-operator">-</span><span class="cm-variable-2">blob</span>.<span class="cm-property">dirtyRegion</span>.<span class="cm-property">left</span><span class="cm-operator">+</span>(<span class="cm-variable-2">dirtySpread</span><span class="cm-operator">*</span><span class="cm-number">2</span>),<span class="cm-variable-2">blob</span>.<span class="cm-property">dirtyRegion</span>.<span class="cm-property">bottom</span><span class="cm-operator">-</span><span class="cm-variable-2">blob</span>.<span class="cm-property">dirtyRegion</span>.<span class="cm-property">top</span><span class="cm-operator">+</span>(<span class="cm-variable-2">dirtySpread</span><span class="cm-operator">*</span><span class="cm-number">2</span>));
      
      <span class="cm-comment">// Reset the dirty region so that it can be expanded anew</span>
      <span class="cm-variable-2">blob</span>.<span class="cm-property">dirtyRegion</span> <span class="cm-operator">=</span> { <span class="cm-property">left</span>: <span class="cm-variable-2">worldRect</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">worldRect</span>.<span class="cm-property">width</span>, <span class="cm-property">top</span>: <span class="cm-variable-2">worldRect</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">worldRect</span>.<span class="cm-property">height</span>, <span class="cm-property">right</span>: <span class="cm-number">0</span>, <span class="cm-property">bottom</span>: <span class="cm-number">0</span> };
    }
    
    <span class="cm-comment">// If there is a merge queued, solve it now</span>
    <span class="cm-keyword">if</span>( <span class="cm-variable-2">mergeQueue</span>.<span class="cm-property">blobA</span> <span class="cm-operator">!=</span> <span class="cm-operator">-</span><span class="cm-number">1</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable-2">mergeQueue</span>.<span class="cm-property">blobB</span> <span class="cm-operator">!=</span> <span class="cm-operator">-</span><span class="cm-number">1</span> ) {
      <span class="cm-variable-2">mergeBlobs</span>( <span class="cm-variable-2">mergeQueue</span>.<span class="cm-property">blobA</span>, <span class="cm-variable-2">mergeQueue</span>.<span class="cm-property">blobB</span> );
      
      <span class="cm-variable-2">mergeQueue</span>.<span class="cm-property">blobA</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;
      <span class="cm-variable-2">mergeQueue</span>.<span class="cm-property">blobB</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;
    }
    
    <span class="cm-comment">// If the mouse is down, start adding the velocity needed to move towards the mouse position</span>
    <span class="cm-keyword">if</span>( <span class="cm-variable-2">dragBlob</span> ) {
      <span class="cm-variable-2">dragBlob</span>.<span class="cm-property">velocity</span>.<span class="cm-property">x</span> <span class="cm-operator">+=</span> ( ( <span class="cm-variable-2">mouseX</span> <span class="cm-operator">+</span> <span class="cm-variable-2">mouseDownOffset</span>.<span class="cm-property">x</span> ) <span class="cm-operator">-</span> <span class="cm-variable-2">dragBlob</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span> ) <span class="cm-operator">*</span> <span class="cm-number">0.01</span>;
      <span class="cm-variable-2">dragBlob</span>.<span class="cm-property">velocity</span>.<span class="cm-property">y</span> <span class="cm-operator">+=</span> ( ( <span class="cm-variable-2">mouseY</span> <span class="cm-operator">+</span> <span class="cm-variable-2">mouseDownOffset</span>.<span class="cm-property">y</span> ) <span class="cm-operator">-</span> <span class="cm-variable-2">dragBlob</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> ) <span class="cm-operator">*</span> <span class="cm-number">0.01</span>;
    }
    
    <span class="cm-keyword">for</span>( <span class="cm-variable-2">u1</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>, <span class="cm-variable-2">ulen</span> <span class="cm-operator">=</span> <span class="cm-variable-2">blobs</span>.<span class="cm-property">length</span>; <span class="cm-variable-2">u1</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">ulen</span>; <span class="cm-variable-2">u1</span><span class="cm-operator">++</span> ) {
      <span class="cm-variable-2">blob</span> <span class="cm-operator">=</span> <span class="cm-variable-2">blobs</span>[<span class="cm-variable-2">u1</span>];
      
      <span class="cm-keyword">for</span>( <span class="cm-variable-2">u2</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable-2">u2</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">ulen</span>; <span class="cm-variable-2">u2</span><span class="cm-operator">++</span> ) {
        <span class="cm-keyword">var</span> <span class="cm-def">otherBlob</span> <span class="cm-operator">=</span> <span class="cm-variable-2">blobs</span>[<span class="cm-variable-2">u2</span>];
        
        <span class="cm-keyword">if</span>( <span class="cm-variable-2">otherBlob</span> <span class="cm-operator">!=</span> <span class="cm-variable-2">blob</span> ) {
          <span class="cm-keyword">var</span> <span class="cm-def">distance</span> <span class="cm-operator">=</span> <span class="cm-variable">distanceBetween</span>( { <span class="cm-property">x</span>: <span class="cm-variable-2">blob</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">blob</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> }, { <span class="cm-property">x</span>: <span class="cm-variable-2">otherBlob</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">otherBlob</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> } );
          
          <span class="cm-keyword">if</span>( <span class="cm-variable-2">distance</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">blob</span>.<span class="cm-property">radius</span> <span class="cm-operator">+</span> <span class="cm-variable-2">otherBlob</span>.<span class="cm-property">radius</span> ) {
            <span class="cm-variable-2">mergeQueue</span>.<span class="cm-property">blobA</span> <span class="cm-operator">=</span> <span class="cm-variable-2">u1</span>;
            <span class="cm-variable-2">mergeQueue</span>.<span class="cm-property">blobB</span> <span class="cm-operator">=</span> <span class="cm-variable-2">u2</span>;
          }
        }
      }
      
      <span class="cm-comment">// Track window movement</span>
      <span class="cm-variable-2">blob</span>.<span class="cm-property">velocity</span>.<span class="cm-property">x</span> <span class="cm-operator">+=</span> ( <span class="cm-variable">window</span>.<span class="cm-property">screenX</span> <span class="cm-operator">-</span> <span class="cm-variable-2">screenX</span> ) <span class="cm-operator">*</span> (<span class="cm-number">0.04</span> <span class="cm-operator">+</span> (<span class="cm-variable">Math</span>.<span class="cm-property">random</span>()<span class="cm-operator">*</span><span class="cm-number">0.1</span>));
      <span class="cm-variable-2">blob</span>.<span class="cm-property">velocity</span>.<span class="cm-property">y</span> <span class="cm-operator">+=</span> ( <span class="cm-variable">window</span>.<span class="cm-property">screenY</span> <span class="cm-operator">-</span> <span class="cm-variable-2">screenY</span> ) <span class="cm-operator">*</span> (<span class="cm-number">0.04</span> <span class="cm-operator">+</span> (<span class="cm-variable">Math</span>.<span class="cm-property">random</span>()<span class="cm-operator">*</span><span class="cm-number">0.1</span>));
      
      <span class="cm-keyword">var</span> <span class="cm-def">friction</span> <span class="cm-operator">=</span> { <span class="cm-property">x</span>: <span class="cm-number">1.035</span>, <span class="cm-property">y</span>: <span class="cm-number">1.035</span> };
      
      <span class="cm-comment">// Enforce horizontal world bounds</span>
      <span class="cm-keyword">if</span>( <span class="cm-variable-2">blob</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span> <span class="cm-operator">&gt;</span> <span class="cm-variable-2">worldRect</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">worldRect</span>.<span class="cm-property">width</span> ) {
        <span class="cm-variable-2">blob</span>.<span class="cm-property">velocity</span>.<span class="cm-property">x</span> <span class="cm-operator">-=</span> ( <span class="cm-variable-2">blob</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">worldRect</span>.<span class="cm-property">width</span> ) <span class="cm-operator">*</span> <span class="cm-number">0.05</span>;
        <span class="cm-variable-2">friction</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-number">1.07</span>;
      }
      <span class="cm-keyword">else</span> <span class="cm-keyword">if</span>( <span class="cm-variable-2">blob</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">worldRect</span>.<span class="cm-property">x</span> ) {
        <span class="cm-variable-2">blob</span>.<span class="cm-property">velocity</span>.<span class="cm-property">x</span> <span class="cm-operator">+=</span> <span class="cm-variable">Math</span>.<span class="cm-property">abs</span>( <span class="cm-variable-2">worldRect</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">blob</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span> ) <span class="cm-operator">*</span> <span class="cm-number">0.05</span>;
        <span class="cm-variable-2">friction</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-number">1.07</span>;
      }
      
      <span class="cm-comment">// Enforce vertical world bounds</span>
      <span class="cm-keyword">if</span>( <span class="cm-variable-2">blob</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> <span class="cm-operator">&gt;</span> <span class="cm-variable-2">worldRect</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">worldRect</span>.<span class="cm-property">height</span> ) {
        <span class="cm-variable-2">blob</span>.<span class="cm-property">velocity</span>.<span class="cm-property">y</span> <span class="cm-operator">-=</span> ( <span class="cm-variable-2">blob</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">worldRect</span>.<span class="cm-property">height</span> ) <span class="cm-operator">*</span> <span class="cm-number">0.05</span>;
        <span class="cm-variable-2">friction</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-number">1.07</span>;
      }
      <span class="cm-keyword">else</span> <span class="cm-keyword">if</span>( <span class="cm-variable-2">blob</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">worldRect</span>.<span class="cm-property">y</span> ) {
        <span class="cm-variable-2">blob</span>.<span class="cm-property">velocity</span>.<span class="cm-property">y</span> <span class="cm-operator">+=</span> <span class="cm-variable">Math</span>.<span class="cm-property">abs</span>( <span class="cm-variable-2">worldRect</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">blob</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> ) <span class="cm-operator">*</span> <span class="cm-number">0.05</span>;
        <span class="cm-variable-2">friction</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-number">1.07</span>;
      }
      
      <span class="cm-comment">// Gravity</span>
      <span class="cm-variable-2">blob</span>.<span class="cm-property">velocity</span>.<span class="cm-property">x</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">gravity</span>.<span class="cm-property">x</span>;
      <span class="cm-variable-2">blob</span>.<span class="cm-property">velocity</span>.<span class="cm-property">y</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">gravity</span>.<span class="cm-property">y</span>;
      
      <span class="cm-comment">// Friction</span>
      <span class="cm-variable-2">blob</span>.<span class="cm-property">velocity</span>.<span class="cm-property">x</span> <span class="cm-operator">/=</span> <span class="cm-variable-2">friction</span>.<span class="cm-property">x</span>;
      <span class="cm-variable-2">blob</span>.<span class="cm-property">velocity</span>.<span class="cm-property">y</span> <span class="cm-operator">/=</span> <span class="cm-variable-2">friction</span>.<span class="cm-property">y</span>;
      
      <span class="cm-comment">// Apply the velocity to the entire blob</span>
      <span class="cm-variable-2">blob</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">blob</span>.<span class="cm-property">velocity</span>.<span class="cm-property">x</span>;
      <span class="cm-variable-2">blob</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">blob</span>.<span class="cm-property">velocity</span>.<span class="cm-property">y</span>;
      
      <span class="cm-keyword">var</span> <span class="cm-def">i</span>, <span class="cm-def">j</span>, <span class="cm-def">len</span>, <span class="cm-def">node</span>, <span class="cm-def">joint</span>, <span class="cm-def">position</span>;
      
      <span class="cm-comment">// Update all node ghosts (previous positions). All nodes need to be synced before the below</span>
      <span class="cm-comment">// calculation loop to avoid tearing between the first nodes</span>
      <span class="cm-keyword">for</span> (<span class="cm-variable-2">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>, <span class="cm-variable-2">len</span> <span class="cm-operator">=</span> <span class="cm-variable-2">blob</span>.<span class="cm-property">nodes</span>.<span class="cm-property">length</span>; <span class="cm-variable-2">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">len</span>; <span class="cm-variable-2">i</span><span class="cm-operator">++</span>) {
        <span class="cm-variable-2">node</span> <span class="cm-operator">=</span> <span class="cm-variable-2">blob</span>.<span class="cm-property">nodes</span>[<span class="cm-variable-2">i</span>];
        
        <span class="cm-variable-2">node</span>.<span class="cm-property">ghost</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable-2">node</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span>;
        <span class="cm-variable-2">node</span>.<span class="cm-property">ghost</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable-2">node</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span>;
      }
      
      <span class="cm-keyword">var</span> <span class="cm-def">dragNode</span> <span class="cm-operator">=</span> <span class="cm-variable-2">blob</span>.<span class="cm-property">nodes</span>[<span class="cm-variable-2">blob</span>.<span class="cm-property">dragNodeIndex</span>];
      <span class="cm-keyword">if</span>( <span class="cm-variable-2">dragNode</span> ) {
        <span class="cm-keyword">var</span> <span class="cm-def">angle</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">atan2</span>( <span class="cm-variable-2">mouseY</span> <span class="cm-operator">-</span> (<span class="cm-variable-2">blob</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span><span class="cm-operator">-</span><span class="cm-number">80</span>), <span class="cm-variable-2">mouseX</span> <span class="cm-operator">-</span> <span class="cm-variable-2">blob</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span> );
        
        <span class="cm-variable-2">blob</span>.<span class="cm-property">rotation</span> <span class="cm-operator">+=</span> ( <span class="cm-variable-2">angle</span> <span class="cm-operator">-</span> <span class="cm-variable-2">blob</span>.<span class="cm-property">rotation</span> ) <span class="cm-operator">*</span> <span class="cm-number">0.03</span>;
        <span class="cm-variable-2">blob</span>.<span class="cm-property">updateNormals</span>();
      }
      
      <span class="cm-comment">// Calculation loop</span>
      <span class="cm-keyword">for</span> (<span class="cm-variable-2">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>, <span class="cm-variable-2">len</span> <span class="cm-operator">=</span> <span class="cm-variable-2">blob</span>.<span class="cm-property">nodes</span>.<span class="cm-property">length</span>; <span class="cm-variable-2">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">len</span>; <span class="cm-variable-2">i</span><span class="cm-operator">++</span>) {
        <span class="cm-variable-2">node</span> <span class="cm-operator">=</span> <span class="cm-variable-2">blob</span>.<span class="cm-property">nodes</span>[<span class="cm-variable-2">i</span>];
        
        <span class="cm-comment">// Move towards the normal target</span>
        <span class="cm-variable-2">node</span>.<span class="cm-property">normal</span>.<span class="cm-property">x</span> <span class="cm-operator">+=</span> ( <span class="cm-variable-2">node</span>.<span class="cm-property">normalTarget</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">node</span>.<span class="cm-property">normal</span>.<span class="cm-property">x</span> ) <span class="cm-operator">*</span> <span class="cm-number">0.05</span>;
        <span class="cm-variable-2">node</span>.<span class="cm-property">normal</span>.<span class="cm-property">y</span> <span class="cm-operator">+=</span> ( <span class="cm-variable-2">node</span>.<span class="cm-property">normalTarget</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">node</span>.<span class="cm-property">normal</span>.<span class="cm-property">y</span> ) <span class="cm-operator">*</span> <span class="cm-number">0.05</span>;
        
        <span class="cm-comment">// This point will be used as the new position for this node, after all factors have been applied</span>
        <span class="cm-variable-2">position</span> <span class="cm-operator">=</span> { <span class="cm-property">x</span>: <span class="cm-variable-2">blob</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span>, <span class="cm-property">y</span>: <span class="cm-variable-2">blob</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> };
        
        <span class="cm-comment">// Apply the joints</span>
        <span class="cm-keyword">for</span>( <span class="cm-variable-2">j</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable-2">j</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">node</span>.<span class="cm-property">joints</span>.<span class="cm-property">length</span>; <span class="cm-variable-2">j</span><span class="cm-operator">++</span> ) {
          <span class="cm-variable-2">joint</span> <span class="cm-operator">=</span> <span class="cm-variable-2">node</span>.<span class="cm-property">joints</span>[<span class="cm-variable-2">j</span>];
          
          <span class="cm-comment">// Determine the strain on the joints</span>
          <span class="cm-keyword">var</span> <span class="cm-def">strainX</span> <span class="cm-operator">=</span> ( (<span class="cm-variable-2">joint</span>.<span class="cm-property">node</span>.<span class="cm-property">ghost</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">node</span>.<span class="cm-property">ghost</span>.<span class="cm-property">x</span>) <span class="cm-operator">-</span> (<span class="cm-variable-2">joint</span>.<span class="cm-property">node</span>.<span class="cm-property">normal</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">node</span>.<span class="cm-property">normal</span>.<span class="cm-property">x</span>) );
          <span class="cm-keyword">var</span> <span class="cm-def">strainY</span> <span class="cm-operator">=</span> ( (<span class="cm-variable-2">joint</span>.<span class="cm-property">node</span>.<span class="cm-property">ghost</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">node</span>.<span class="cm-property">ghost</span>.<span class="cm-property">y</span>) <span class="cm-operator">-</span> (<span class="cm-variable-2">joint</span>.<span class="cm-property">node</span>.<span class="cm-property">normal</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">node</span>.<span class="cm-property">normal</span>.<span class="cm-property">y</span>) );
          
          <span class="cm-variable-2">position</span>.<span class="cm-property">x</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">strainX</span> <span class="cm-operator">*</span> <span class="cm-variable-2">joint</span>.<span class="cm-property">strength</span>;
          <span class="cm-variable-2">position</span>.<span class="cm-property">y</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">strainY</span> <span class="cm-operator">*</span> <span class="cm-variable-2">joint</span>.<span class="cm-property">strength</span>;
        }
        
        <span class="cm-comment">// Offset by the normal</span>
        <span class="cm-variable-2">position</span>.<span class="cm-property">x</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">node</span>.<span class="cm-property">normal</span>.<span class="cm-property">x</span>;
        <span class="cm-variable-2">position</span>.<span class="cm-property">y</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">node</span>.<span class="cm-property">normal</span>.<span class="cm-property">y</span>;
        
        <span class="cm-comment">// Apply the drag offset (if applicable)</span>
        <span class="cm-keyword">if</span>( <span class="cm-variable-2">i</span> <span class="cm-operator">==</span> <span class="cm-variable-2">blob</span>.<span class="cm-property">dragNodeIndex</span> ) {
          <span class="cm-variable-2">position</span>.<span class="cm-property">x</span> <span class="cm-operator">+=</span> ( <span class="cm-variable-2">mouseX</span> <span class="cm-operator">-</span> <span class="cm-variable-2">position</span>.<span class="cm-property">x</span> ) <span class="cm-operator">*</span> <span class="cm-number">0.98</span>;
          <span class="cm-variable-2">position</span>.<span class="cm-property">y</span> <span class="cm-operator">+=</span> ( <span class="cm-variable-2">mouseY</span> <span class="cm-operator">-</span> <span class="cm-variable-2">position</span>.<span class="cm-property">y</span> ) <span class="cm-operator">*</span> <span class="cm-number">0.98</span>;
        }
        
        <span class="cm-comment">// Apply the calculated position to the node (with easing)</span>
        <span class="cm-variable-2">node</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span> <span class="cm-operator">+=</span> ( <span class="cm-variable-2">position</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">node</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span> ) <span class="cm-operator">*</span> <span class="cm-number">0.1</span>;
        <span class="cm-variable-2">node</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> <span class="cm-operator">+=</span> ( <span class="cm-variable-2">position</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">node</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> ) <span class="cm-operator">*</span> <span class="cm-number">0.1</span>;
        
        <span class="cm-comment">// Limit the node position to screen bounds</span>
        <span class="cm-variable-2">node</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">max</span>( <span class="cm-variable">Math</span>.<span class="cm-property">min</span>( <span class="cm-variable-2">node</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span>, <span class="cm-variable-2">worldRect</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">worldRect</span>.<span class="cm-property">width</span> ), <span class="cm-variable-2">worldRect</span>.<span class="cm-property">x</span> );
        <span class="cm-variable-2">node</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">max</span>( <span class="cm-variable">Math</span>.<span class="cm-property">min</span>( <span class="cm-variable-2">node</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span>, <span class="cm-variable-2">worldRect</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">worldRect</span>.<span class="cm-property">height</span> ), <span class="cm-variable-2">worldRect</span>.<span class="cm-property">y</span> );
        
        <span class="cm-comment">// Expand the dirty rect if needed</span>
        <span class="cm-variable-2">blob</span>.<span class="cm-property">dirtyRegion</span>.<span class="cm-property">left</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">min</span>(<span class="cm-variable-2">blob</span>.<span class="cm-property">dirtyRegion</span>.<span class="cm-property">left</span>, <span class="cm-variable-2">node</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span>);
        <span class="cm-variable-2">blob</span>.<span class="cm-property">dirtyRegion</span>.<span class="cm-property">top</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">min</span>(<span class="cm-variable-2">blob</span>.<span class="cm-property">dirtyRegion</span>.<span class="cm-property">top</span>, <span class="cm-variable-2">node</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span>);
        <span class="cm-variable-2">blob</span>.<span class="cm-property">dirtyRegion</span>.<span class="cm-property">right</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">max</span>(<span class="cm-variable-2">blob</span>.<span class="cm-property">dirtyRegion</span>.<span class="cm-property">right</span>, <span class="cm-variable-2">node</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span>);
        <span class="cm-variable-2">blob</span>.<span class="cm-property">dirtyRegion</span>.<span class="cm-property">bottom</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">max</span>(<span class="cm-variable-2">blob</span>.<span class="cm-property">dirtyRegion</span>.<span class="cm-property">bottom</span>, <span class="cm-variable-2">node</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span>);
      }
      
      <span class="cm-keyword">if</span>( <span class="cm-operator">!</span><span class="cm-variable-2">skin</span>.<span class="cm-property">debug</span> ) {
           <span class="cm-variable-2">context</span>.<span class="cm-property">beginPath</span>();
        <span class="cm-variable-2">context</span>.<span class="cm-property">fillStyle</span> <span class="cm-operator">=</span> <span class="cm-variable-2">skin</span>.<span class="cm-property">fillStyle</span>;
        <span class="cm-variable-2">context</span>.<span class="cm-property">strokeStyle</span> <span class="cm-operator">=</span> <span class="cm-variable-2">skin</span>.<span class="cm-property">strokeStyle</span>;
        <span class="cm-variable-2">context</span>.<span class="cm-property">lineWidth</span> <span class="cm-operator">=</span> <span class="cm-variable-2">skin</span>.<span class="cm-property">lineWidth</span>;
      }
      
      <span class="cm-keyword">var</span> <span class="cm-def">cn</span> <span class="cm-operator">=</span> <span class="cm-variable">getArrayElementByOffset</span>( <span class="cm-variable-2">blob</span>.<span class="cm-property">nodes</span>, <span class="cm-number">0</span>, <span class="cm-operator">-</span><span class="cm-number">1</span> ); <span class="cm-comment">// current node</span>
      <span class="cm-keyword">var</span> <span class="cm-def">nn</span> <span class="cm-operator">=</span> <span class="cm-variable">getArrayElementByOffset</span>( <span class="cm-variable-2">blob</span>.<span class="cm-property">nodes</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span> ); <span class="cm-comment">// next node</span>
      
      <span class="cm-comment">// Move to the first anchor</span>
      <span class="cm-variable-2">context</span>.<span class="cm-property">moveTo</span>( <span class="cm-variable-2">cn</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> ( <span class="cm-variable-2">nn</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">cn</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span> ) <span class="cm-operator">/</span> <span class="cm-number">2</span>, <span class="cm-variable-2">cn</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> ( <span class="cm-variable-2">nn</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">cn</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> ) <span class="cm-operator">/</span> <span class="cm-number">2</span> );
      
      <span class="cm-comment">// Rendering loop</span>
      <span class="cm-keyword">for</span> (<span class="cm-variable-2">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>, <span class="cm-variable-2">len</span> <span class="cm-operator">=</span> <span class="cm-variable-2">blob</span>.<span class="cm-property">nodes</span>.<span class="cm-property">length</span>; <span class="cm-variable-2">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">len</span>; <span class="cm-variable-2">i</span><span class="cm-operator">++</span>) {
        <span class="cm-variable-2">cn</span> <span class="cm-operator">=</span> <span class="cm-variable">getArrayElementByOffset</span>( <span class="cm-variable-2">blob</span>.<span class="cm-property">nodes</span>, <span class="cm-variable-2">i</span>, <span class="cm-number">0</span> );
        <span class="cm-variable-2">nn</span> <span class="cm-operator">=</span> <span class="cm-variable">getArrayElementByOffset</span>( <span class="cm-variable-2">blob</span>.<span class="cm-property">nodes</span>, <span class="cm-variable-2">i</span>, <span class="cm-number">1</span> );
        
        <span class="cm-keyword">if</span>( <span class="cm-variable-2">skin</span>.<span class="cm-property">debug</span> ) {
          <span class="cm-variable-2">context</span>.<span class="cm-property">beginPath</span>();
          <span class="cm-variable-2">context</span>.<span class="cm-property">lineWidth</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>;
          <span class="cm-variable-2">context</span>.<span class="cm-property">strokeStyle</span> <span class="cm-operator">=</span> <span class="cm-string">"#ababab"</span>;
          
          <span class="cm-keyword">for</span>( <span class="cm-variable-2">j</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable-2">j</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">cn</span>.<span class="cm-property">joints</span>.<span class="cm-property">length</span>; <span class="cm-variable-2">j</span><span class="cm-operator">++</span> ) {
            <span class="cm-variable-2">joint</span> <span class="cm-operator">=</span> <span class="cm-variable-2">cn</span>.<span class="cm-property">joints</span>[<span class="cm-variable-2">j</span>];
            <span class="cm-variable-2">context</span>.<span class="cm-property">moveTo</span>( <span class="cm-variable-2">cn</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span>, <span class="cm-variable-2">cn</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> );
            <span class="cm-variable-2">context</span>.<span class="cm-property">lineTo</span>( <span class="cm-variable-2">joint</span>.<span class="cm-property">node</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span>, <span class="cm-variable-2">joint</span>.<span class="cm-property">node</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> );
          }
          
          <span class="cm-variable-2">context</span>.<span class="cm-property">stroke</span>();
          
          <span class="cm-variable-2">context</span>.<span class="cm-property">beginPath</span>();
          <span class="cm-variable-2">context</span>.<span class="cm-property">fillStyle</span> <span class="cm-operator">=</span> <span class="cm-variable-2">i</span> <span class="cm-operator">==</span> <span class="cm-number">0</span><span class="cm-operator">?</span> <span class="cm-string">"#00ff00"</span> : <span class="cm-string">"#dddddd"</span>;
          <span class="cm-variable-2">context</span>.<span class="cm-property">arc</span>(<span class="cm-variable-2">cn</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span>, <span class="cm-variable-2">cn</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span>, <span class="cm-number">5</span>, <span class="cm-number">0</span>, <span class="cm-variable">Math</span>.<span class="cm-property">PI</span><span class="cm-operator">*</span><span class="cm-number">2</span>, <span class="cm-atom">true</span>);
          <span class="cm-variable-2">context</span>.<span class="cm-property">fill</span>();
        }
        <span class="cm-keyword">else</span> {
          <span class="cm-variable-2">context</span>.<span class="cm-property">quadraticCurveTo</span>( <span class="cm-variable-2">cn</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span>, <span class="cm-variable-2">cn</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span>, <span class="cm-variable-2">cn</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> ( <span class="cm-variable-2">nn</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span> <span class="cm-operator">-</span> <span class="cm-variable-2">cn</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span> ) <span class="cm-operator">/</span> <span class="cm-number">2</span>, <span class="cm-variable-2">cn</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> ( <span class="cm-variable-2">nn</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> <span class="cm-operator">-</span> <span class="cm-variable-2">cn</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> ) <span class="cm-operator">/</span> <span class="cm-number">2</span> );
        }
      }
      
      <span class="cm-keyword">if</span>( <span class="cm-variable-2">skin</span>.<span class="cm-property">debug</span> ) {
<span class="cm-comment">//        context.beginPath();</span>
<span class="cm-comment">//        context.fillStyle = "rgba(100,255,100,0.3)";</span>
<span class="cm-comment">//        context.fillRect(blob.dirtyRegion.left-dirtySpread,blob.dirtyRegion.top-dirtySpread,blob.dirtyRegion.right-blob.dirtyRegion.left+(dirtySpread*2),blob.dirtyRegion.bottom-blob.dirtyRegion.top+(dirtySpread*2));</span>
<span class="cm-comment">//        context.fill();</span>
      }
      
      <span class="cm-variable-2">context</span>.<span class="cm-property">stroke</span>();
      <span class="cm-variable-2">context</span>.<span class="cm-property">fill</span>();
    }
    
    <span class="cm-variable-2">screenX</span> <span class="cm-operator">=</span> <span class="cm-variable">window</span>.<span class="cm-property">screenX</span>;
    <span class="cm-variable-2">screenY</span> <span class="cm-operator">=</span> <span class="cm-variable">window</span>.<span class="cm-property">screenY</span>;
  }
    
  
};

<span class="cm-keyword">function</span> <span class="cm-def">Blob</span>() {
  <span class="cm-keyword">this</span>.<span class="cm-property">position</span> <span class="cm-operator">=</span> { <span class="cm-property">x</span>: <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-number">0</span> };
  <span class="cm-keyword">this</span>.<span class="cm-property">velocity</span> <span class="cm-operator">=</span> { <span class="cm-property">x</span>: <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-number">0</span> };
  <span class="cm-keyword">this</span>.<span class="cm-property">radius</span> <span class="cm-operator">=</span> <span class="cm-number">120</span>;
  <span class="cm-keyword">this</span>.<span class="cm-property">quality</span> <span class="cm-operator">=</span> <span class="cm-number">32</span>;
  <span class="cm-keyword">this</span>.<span class="cm-property">nodes</span> <span class="cm-operator">=</span> [];
  <span class="cm-keyword">this</span>.<span class="cm-property">rotation</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-variable">Math</span>.<span class="cm-property">PI</span> <span class="cm-operator">*</span> <span class="cm-number">0.5</span>;
  <span class="cm-keyword">this</span>.<span class="cm-property">dragNodeIndex</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;
  <span class="cm-keyword">this</span>.<span class="cm-property">dirtyRegion</span> <span class="cm-operator">=</span> { <span class="cm-property">left</span>: <span class="cm-number">0</span>, <span class="cm-property">top</span>: <span class="cm-number">0</span>, <span class="cm-property">right</span>: <span class="cm-number">0</span>, <span class="cm-property">bottom</span>: <span class="cm-number">0</span> };
  <span class="cm-keyword">this</span>.<span class="cm-property">lastSplitTime</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;
  
  <span class="cm-keyword">this</span>.<span class="cm-property">generateNodes</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>() {
    <span class="cm-keyword">this</span>.<span class="cm-property">nodes</span> <span class="cm-operator">=</span> [];
    
    <span class="cm-keyword">var</span> <span class="cm-def">i</span>, <span class="cm-def">n</span>;
    
    <span class="cm-keyword">for</span> (<span class="cm-variable-2">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable-2">i</span> <span class="cm-operator">&lt;</span> <span class="cm-keyword">this</span>.<span class="cm-property">quality</span>; <span class="cm-variable-2">i</span><span class="cm-operator">++</span>) {
      <span class="cm-variable-2">n</span> <span class="cm-operator">=</span> {
        <span class="cm-property">normal</span>: { <span class="cm-property">x</span>: <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-number">0</span> },
        <span class="cm-property">normalTarget</span>: { <span class="cm-property">x</span>: <span class="cm-number">0</span>, <span class="cm-property">y</span>: <span class="cm-number">0</span> },
        <span class="cm-property">position</span>: { <span class="cm-property">x</span>: <span class="cm-keyword">this</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span>, <span class="cm-property">y</span>: <span class="cm-keyword">this</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> },
        <span class="cm-property">ghost</span>: { <span class="cm-property">x</span>: <span class="cm-keyword">this</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span>, <span class="cm-property">y</span>: <span class="cm-keyword">this</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> },
        <span class="cm-property">angle</span>: <span class="cm-number">0</span>
      };
      
      <span class="cm-keyword">this</span>.<span class="cm-property">nodes</span>.<span class="cm-property">push</span>( <span class="cm-variable-2">n</span> );
    }
    
    <span class="cm-keyword">this</span>.<span class="cm-property">updateJoints</span>();
    
    <span class="cm-keyword">this</span>.<span class="cm-property">updateNormals</span>();
  };
  
  <span class="cm-keyword">this</span>.<span class="cm-property">updateJoints</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>() {
    <span class="cm-keyword">for</span> (<span class="cm-keyword">var</span> <span class="cm-def">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable-2">i</span> <span class="cm-operator">&lt;</span> <span class="cm-keyword">this</span>.<span class="cm-property">quality</span>; <span class="cm-variable-2">i</span><span class="cm-operator">++</span>) {
      <span class="cm-keyword">var</span> <span class="cm-def">n</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">nodes</span>[<span class="cm-variable-2">i</span>];
      
      <span class="cm-variable-2">n</span>.<span class="cm-property">joints</span> <span class="cm-operator">=</span> [
        { 
          <span class="cm-property">node</span>: <span class="cm-variable">getArrayElementByOffset</span>( <span class="cm-keyword">this</span>.<span class="cm-property">nodes</span>, <span class="cm-variable-2">i</span>, <span class="cm-operator">-</span><span class="cm-number">1</span> ),
          <span class="cm-property">strength</span>: <span class="cm-number">2.2</span>
        },
        { 
          <span class="cm-property">node</span>: <span class="cm-variable">getArrayElementByOffset</span>( <span class="cm-keyword">this</span>.<span class="cm-property">nodes</span>, <span class="cm-variable-2">i</span>, <span class="cm-number">1</span> ),
          <span class="cm-property">strength</span>: <span class="cm-number">2.2</span>
        }
      ];
      
      <span class="cm-variable-2">n</span>.<span class="cm-property">joints</span>.<span class="cm-property">push</span>( { 
        <span class="cm-property">node</span>: <span class="cm-variable">getArrayElementByOffset</span>( <span class="cm-keyword">this</span>.<span class="cm-property">nodes</span>, <span class="cm-variable-2">i</span>, <span class="cm-operator">-</span><span class="cm-number">2</span> ),
        <span class="cm-property">strength</span>: <span class="cm-number">2.2</span>
      } );
      
      <span class="cm-variable-2">n</span>.<span class="cm-property">joints</span>.<span class="cm-property">push</span>( { 
        <span class="cm-property">node</span>: <span class="cm-variable">getArrayElementByOffset</span>( <span class="cm-keyword">this</span>.<span class="cm-property">nodes</span>, <span class="cm-variable-2">i</span>, <span class="cm-number">2</span> ),
        <span class="cm-property">strength</span>: <span class="cm-number">2.2</span>
      } );
      
    }
  };
  
  <span class="cm-keyword">this</span>.<span class="cm-property">updateNormals</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>() {
    <span class="cm-keyword">var</span> <span class="cm-def">i</span>, <span class="cm-def">j</span>, <span class="cm-def">n</span>;
    
    <span class="cm-keyword">for</span> (<span class="cm-variable-2">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable-2">i</span> <span class="cm-operator">&lt;</span> <span class="cm-keyword">this</span>.<span class="cm-property">quality</span>; <span class="cm-variable-2">i</span><span class="cm-operator">++</span>) {
      
      <span class="cm-keyword">var</span> <span class="cm-def">n</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">nodes</span>[<span class="cm-variable-2">i</span>];
      
      <span class="cm-keyword">if</span>( <span class="cm-keyword">this</span>.<span class="cm-property">dragNodeIndex</span> <span class="cm-operator">!=</span> <span class="cm-operator">-</span><span class="cm-number">1</span> ) {
        <span class="cm-variable-2">j</span> <span class="cm-operator">=</span> <span class="cm-variable-2">i</span> <span class="cm-operator">-</span> <span class="cm-keyword">this</span>.<span class="cm-property">dragNodeIndex</span>;
        <span class="cm-variable-2">j</span> <span class="cm-operator">=</span> <span class="cm-variable-2">j</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span> <span class="cm-operator">?</span> <span class="cm-keyword">this</span>.<span class="cm-property">quality</span> <span class="cm-operator">+</span> <span class="cm-variable-2">j</span> : <span class="cm-variable-2">j</span>;
      }
      <span class="cm-keyword">else</span> {
        <span class="cm-variable-2">j</span> <span class="cm-operator">=</span> <span class="cm-variable-2">i</span>;
      }
      
      <span class="cm-variable-2">n</span>.<span class="cm-property">angle</span> <span class="cm-operator">=</span> ( (<span class="cm-variable-2">j</span> <span class="cm-operator">/</span> <span class="cm-keyword">this</span>.<span class="cm-property">quality</span> ) <span class="cm-operator">*</span> <span class="cm-variable">Math</span>.<span class="cm-property">PI</span> <span class="cm-operator">*</span> <span class="cm-number">2</span> ) <span class="cm-operator">+</span> <span class="cm-keyword">this</span>.<span class="cm-property">rotation</span>;
      
      <span class="cm-variable-2">n</span>.<span class="cm-property">normalTarget</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">cos</span>( <span class="cm-variable-2">n</span>.<span class="cm-property">angle</span> ) <span class="cm-operator">*</span> <span class="cm-keyword">this</span>.<span class="cm-property">radius</span>;
      <span class="cm-variable-2">n</span>.<span class="cm-property">normalTarget</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">sin</span>( <span class="cm-variable-2">n</span>.<span class="cm-property">angle</span> ) <span class="cm-operator">*</span> <span class="cm-keyword">this</span>.<span class="cm-property">radius</span>;
      
      <span class="cm-keyword">if</span>( <span class="cm-variable-2">n</span>.<span class="cm-property">normal</span>.<span class="cm-property">x</span> <span class="cm-operator">==</span> <span class="cm-number">0</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable-2">n</span>.<span class="cm-property">normal</span>.<span class="cm-property">y</span> <span class="cm-operator">==</span> <span class="cm-number">0</span> ) {
        <span class="cm-variable-2">n</span>.<span class="cm-property">normal</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable-2">n</span>.<span class="cm-property">normalTarget</span>.<span class="cm-property">x</span>;
        <span class="cm-variable-2">n</span>.<span class="cm-property">normal</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable-2">n</span>.<span class="cm-property">normalTarget</span>.<span class="cm-property">y</span>;
      }
    }
  };
  
  <span class="cm-keyword">this</span>.<span class="cm-property">split</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>() {
    
    <span class="cm-keyword">var</span> <span class="cm-def">velocitySpread</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">radius</span> <span class="cm-operator">/</span> <span class="cm-number">10</span>;
    <span class="cm-keyword">var</span> <span class="cm-def">nodeSpread</span> <span class="cm-operator">=</span> <span class="cm-variable">Math</span>.<span class="cm-property">round</span>( <span class="cm-keyword">this</span>.<span class="cm-property">nodes</span>.<span class="cm-property">length</span> <span class="cm-operator">*</span> <span class="cm-number">0.5</span> );
    <span class="cm-keyword">var</span> <span class="cm-def">radiusSpread</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">radius</span> <span class="cm-operator">*</span> <span class="cm-number">0.5</span>;
    
    <span class="cm-keyword">var</span> <span class="cm-def">sibling</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Blob</span>();
    
    <span class="cm-variable-2">sibling</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">position</span>.<span class="cm-property">x</span>;
    <span class="cm-variable-2">sibling</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">position</span>.<span class="cm-property">y</span>;
    
    <span class="cm-variable-2">sibling</span>.<span class="cm-property">velocity</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable-2">velocitySpread</span>;
    <span class="cm-variable-2">sibling</span>.<span class="cm-property">velocity</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">velocity</span>.<span class="cm-property">y</span>;
    
    <span class="cm-variable-2">sibling</span>.<span class="cm-property">nodes</span> <span class="cm-operator">=</span> [];
    
    <span class="cm-keyword">var</span> <span class="cm-def">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;
    <span class="cm-keyword">while</span>( <span class="cm-variable-2">i</span><span class="cm-operator">++</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">nodeSpread</span> ) {
      <span class="cm-variable-2">sibling</span>.<span class="cm-property">nodes</span>.<span class="cm-property">push</span>( <span class="cm-keyword">this</span>.<span class="cm-property">nodes</span>.<span class="cm-property">shift</span>() );
    }
    
    <span class="cm-variable-2">sibling</span>.<span class="cm-property">radius</span> <span class="cm-operator">=</span> <span class="cm-variable-2">radiusSpread</span>;
    <span class="cm-variable-2">sibling</span>.<span class="cm-property">quality</span> <span class="cm-operator">=</span> <span class="cm-variable-2">sibling</span>.<span class="cm-property">nodes</span>.<span class="cm-property">length</span>;
    
    <span class="cm-keyword">this</span>.<span class="cm-property">velocity</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-variable-2">velocitySpread</span>;
    <span class="cm-keyword">this</span>.<span class="cm-property">radius</span> <span class="cm-operator">=</span> <span class="cm-variable-2">radiusSpread</span>;
    <span class="cm-keyword">this</span>.<span class="cm-property">quality</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">nodes</span>.<span class="cm-property">length</span>;
    
    <span class="cm-keyword">this</span>.<span class="cm-property">dragNodeIndex</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;
    <span class="cm-keyword">this</span>.<span class="cm-property">updateJoints</span>();
    <span class="cm-keyword">this</span>.<span class="cm-property">updateNormals</span>();
    
    <span class="cm-variable-2">sibling</span>.<span class="cm-property">dragNodeIndex</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;
    <span class="cm-variable-2">sibling</span>.<span class="cm-property">updateJoints</span>();
    <span class="cm-variable-2">sibling</span>.<span class="cm-property">updateNormals</span>();
    
    <span class="cm-variable-2">sibling</span>.<span class="cm-property">lastSplitTime</span> <span class="cm-operator">=</span> <span class="cm-variable">getTime</span>();
    <span class="cm-keyword">this</span>.<span class="cm-property">lastSplitTime</span> <span class="cm-operator">=</span> <span class="cm-variable">getTime</span>();
    
    <span class="cm-keyword">return</span> <span class="cm-variable-2">sibling</span>;
    
  };
  
  <span class="cm-keyword">this</span>.<span class="cm-property">merge</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>( <span class="cm-def">sibling</span> ) {
    <span class="cm-keyword">this</span>.<span class="cm-property">velocity</span>.<span class="cm-property">x</span> <span class="cm-operator">*=</span> <span class="cm-number">0.5</span>;
    <span class="cm-keyword">this</span>.<span class="cm-property">velocity</span>.<span class="cm-property">y</span> <span class="cm-operator">*=</span> <span class="cm-number">0.5</span>;
    
    <span class="cm-keyword">this</span>.<span class="cm-property">velocity</span>.<span class="cm-property">x</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">sibling</span>.<span class="cm-property">velocity</span>.<span class="cm-property">x</span> <span class="cm-operator">*</span> <span class="cm-number">0.5</span>;
    <span class="cm-keyword">this</span>.<span class="cm-property">velocity</span>.<span class="cm-property">y</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">sibling</span>.<span class="cm-property">velocity</span>.<span class="cm-property">y</span> <span class="cm-operator">*</span> <span class="cm-number">0.5</span>;
    
    <span class="cm-keyword">while</span>( <span class="cm-variable-2">sibling</span>.<span class="cm-property">nodes</span>.<span class="cm-property">length</span> ) {
      <span class="cm-keyword">this</span>.<span class="cm-property">nodes</span>.<span class="cm-property">push</span>( <span class="cm-variable-2">sibling</span>.<span class="cm-property">nodes</span>.<span class="cm-property">shift</span>() );
    }
    
    <span class="cm-keyword">this</span>.<span class="cm-property">quality</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">nodes</span>.<span class="cm-property">length</span>;
    <span class="cm-keyword">this</span>.<span class="cm-property">radius</span> <span class="cm-operator">+=</span> <span class="cm-variable-2">sibling</span>.<span class="cm-property">radius</span>;
    
    <span class="cm-keyword">this</span>.<span class="cm-property">dragNodeIndex</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;
    
    <span class="cm-keyword">this</span>.<span class="cm-property">updateNormals</span>();
    <span class="cm-keyword">this</span>.<span class="cm-property">organizeNodesByProximity</span>();
    <span class="cm-keyword">this</span>.<span class="cm-property">updateJoints</span>();
  };
  
  <span class="cm-keyword">this</span>.<span class="cm-property">organizeNodesByProximity</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>() {
    <span class="cm-keyword">var</span> <span class="cm-def">i</span>, <span class="cm-def">j</span>, <span class="cm-def">outer</span>, <span class="cm-def">inner</span>;
    
    <span class="cm-keyword">var</span> <span class="cm-def">closestDistance</span>, <span class="cm-def">currentDistance</span>, <span class="cm-def">closestIndex</span>;
    
    <span class="cm-keyword">var</span> <span class="cm-def">newNodes</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-property">nodes</span>.<span class="cm-property">concat</span>();
    <span class="cm-keyword">var</span> <span class="cm-def">blackListed</span> <span class="cm-operator">=</span> [];
    
    <span class="cm-keyword">for</span> (<span class="cm-variable-2">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable-2">i</span> <span class="cm-operator">&lt;</span> <span class="cm-keyword">this</span>.<span class="cm-property">quality</span>; <span class="cm-variable-2">i</span><span class="cm-operator">++</span>) {
      <span class="cm-variable-2">outer</span> <span class="cm-operator">=</span> <span class="cm-variable-2">newNodes</span>[<span class="cm-variable-2">i</span>];
      
      <span class="cm-variable-2">currentDistance</span> <span class="cm-operator">=</span> <span class="cm-number">9999</span>;
      <span class="cm-variable-2">closestDistance</span> <span class="cm-operator">=</span> <span class="cm-number">9999</span>;
      <span class="cm-variable-2">closestIndex</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;
      
      <span class="cm-keyword">for</span>(<span class="cm-variable-2">j</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable-2">j</span> <span class="cm-operator">&lt;</span> <span class="cm-keyword">this</span>.<span class="cm-property">quality</span>; <span class="cm-variable-2">j</span><span class="cm-operator">++</span>) {
        <span class="cm-variable-2">inner</span> <span class="cm-operator">=</span> <span class="cm-variable-2">newNodes</span>[<span class="cm-variable-2">j</span>];
        
        <span class="cm-variable-2">currentDistance</span> <span class="cm-operator">=</span> <span class="cm-variable">distanceBetween</span>( <span class="cm-variable-2">inner</span>.<span class="cm-property">position</span>, <span class="cm-variable-2">outer</span>.<span class="cm-property">position</span> );
        
        <span class="cm-keyword">if</span>( <span class="cm-variable-2">currentDistance</span> <span class="cm-operator">&lt;</span> <span class="cm-variable-2">closestDistance</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable-2">blackListed</span>.<span class="cm-property">indexOf</span>(<span class="cm-variable-2">inner</span>) <span class="cm-operator">===</span> <span class="cm-operator">-</span><span class="cm-number">1</span> ) {
          <span class="cm-variable-2">closestDistance</span> <span class="cm-operator">=</span> <span class="cm-variable-2">currentDistance</span>;
          <span class="cm-variable-2">closestIndex</span> <span class="cm-operator">=</span> <span class="cm-variable-2">j</span>;
        }
      }
      
      <span class="cm-keyword">this</span>.<span class="cm-property">nodes</span>[<span class="cm-variable-2">i</span>] <span class="cm-operator">=</span> <span class="cm-variable-2">newNodes</span>[<span class="cm-variable-2">closestIndex</span>];
    }
    
  };
}

<span class="cm-keyword">function</span> <span class="cm-def">getArrayElementByOffset</span>( <span class="cm-def">array</span>, <span class="cm-def">index</span>, <span class="cm-def">offset</span> ) {
  <span class="cm-keyword">if</span>( <span class="cm-variable-2">array</span>[<span class="cm-variable-2">index</span><span class="cm-operator">+</span><span class="cm-variable-2">offset</span>] ) {
    <span class="cm-keyword">return</span> <span class="cm-variable-2">array</span>[<span class="cm-variable-2">index</span><span class="cm-operator">+</span><span class="cm-variable-2">offset</span>];
  }
  
  <span class="cm-keyword">if</span>( <span class="cm-variable-2">index</span><span class="cm-operator">+</span><span class="cm-variable-2">offset</span> <span class="cm-operator">&gt;</span> <span class="cm-variable-2">array</span>.<span class="cm-property">length</span><span class="cm-operator">-</span><span class="cm-number">1</span> ) {
    <span class="cm-keyword">return</span> <span class="cm-variable-2">array</span>[<span class="cm-variable-2">index</span> <span class="cm-operator">-</span> <span class="cm-variable-2">array</span>.<span class="cm-property">length</span> <span class="cm-operator">+</span> <span class="cm-variable-2">offset</span>];
  }
  
  <span class="cm-keyword">if</span>( <span class="cm-variable-2">index</span><span class="cm-operator">+</span><span class="cm-variable-2">offset</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span> ) {
    <span class="cm-keyword">return</span> <span class="cm-variable-2">array</span>[<span class="cm-variable-2">array</span>.<span class="cm-property">length</span> <span class="cm-operator">+</span> ( <span class="cm-variable-2">index</span> <span class="cm-operator">+</span> <span class="cm-variable-2">offset</span> )];
  }
}

<span class="cm-keyword">function</span> <span class="cm-def">sortByField</span>( <span class="cm-def">list</span>, <span class="cm-def">field</span> ) {
  <span class="cm-keyword">var</span> <span class="cm-def">sortOnField</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>( <span class="cm-def">a</span>, <span class="cm-def">b</span> ) {
    <span class="cm-keyword">return</span> <span class="cm-variable-2">a</span>[<span class="cm-variable-2">field</span>] <span class="cm-operator">-</span> <span class="cm-variable-2">b</span>[<span class="cm-variable-2">field</span>];
  };
  
  <span class="cm-variable-2">list</span>.<span class="cm-property">sort</span>( <span class="cm-variable-2">sortOnField</span> );
}

<span class="cm-keyword">function</span> <span class="cm-def">getTime</span>() {
  <span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">Date</span>().<span class="cm-property">getTime</span>();
}

<span class="cm-keyword">function</span> <span class="cm-def">distanceBetween</span>(<span class="cm-def">p1</span>,<span class="cm-def">p2</span>) {
  <span class="cm-keyword">var</span> <span class="cm-def">dx</span> <span class="cm-operator">=</span> <span class="cm-variable-2">p2</span>.<span class="cm-property">x</span><span class="cm-operator">-</span><span class="cm-variable-2">p1</span>.<span class="cm-property">x</span>;
  <span class="cm-keyword">var</span> <span class="cm-def">dy</span> <span class="cm-operator">=</span> <span class="cm-variable-2">p2</span>.<span class="cm-property">y</span><span class="cm-operator">-</span><span class="cm-variable-2">p1</span>.<span class="cm-property">y</span>;
  <span class="cm-keyword">return</span> <span class="cm-variable">Math</span>.<span class="cm-property">sqrt</span>(<span class="cm-variable-2">dx</span><span class="cm-operator">*</span><span class="cm-variable-2">dx</span> <span class="cm-operator">+</span> <span class="cm-variable-2">dy</span><span class="cm-operator">*</span><span class="cm-variable-2">dy</span>);
}


<span class="cm-variable">BlobWorld</span>.<span class="cm-property">init</span>();
  
  </code></pre>
</div>
<div id="result-box" class="code-box active zoom-1" role="region" aria-label="Result">
<iframe allow="accelerometer; camera; encrypted-media; display-capture; geolocation; gyroscope; microphone; midi; clipboard-read; clipboard-write; web-share" allowfullscreen="true" allowpaymentrequest="true" allowtransparency="true" class="result-iframe  " frameborder="0" id="result-iframe" loading="lazy" name="CodePen Preview for Blob" sandbox="allow-forms allow-modals allow-pointer-lock allow-popups allow-same-origin allow-scripts allow-top-navigation-by-user-activation allow-downloads allow-presentation" scrolling="yes" title="CodePen Preview for Blob" data-src="https://cdpn.io/hakimel/fullembedgrid/DzmKrk?animations=run&amp;type=embed" src="./DzmKrk.html">
  </iframe>
</div>
<div id="about-box">
<div class="about-container">
<div class="about-user">
<a href="https://codepen.io/hakimel" target="_blank" rel="noopener"><img src="./default(3).png" loading="lazy" alt="" class="about-image"></a>
<div class="about-user-info">
<p>
This Pen is owned by <a href="https://codepen.io/hakimel" target="_blank" rel="noopener">Hakim El Hattab</a> on <a href="https://codepen.io/" target="_blank" rel="noopener">CodePen</a>.
</p>
<p>
<a href="https://codepen.io/hakimel" target="_blank" rel="noopener" class="about-user-more">
See more by @hakimel on CodePen
</a>
</p>
</div>
</div>
</div>
</div>
<div id="resources-box" class="resources-box">
<h3>External CSS</h3>
<p>
This Pen doesn't use any external CSS resources.
</p>
<h3>External JavaScript</h3>
<p>
This Pen doesn't use any external JavaScript resources.
</p>
</div>
</div>
<footer class="embed-footer" id="embed-footer">
<button id="resources-link" class="resources-link action-button bottom left" href="#resources-box" aria-pressed="false" role="button">
Resources
</button>
<ul class="scaling-choices bottom right">
<li><button class="action-button" id="zoom-button-1">1</button></li>
<li><button class="action-button" id="zoom-button-05">0.5</button></li>
<li><button class="action-button" id="zoom-button-025">0.25</button></li>
</ul>
<button id="rerun-button" class="action-button rerun-button bottom right">
Rerun
</button>
</footer>
<script nonce="">
    __processedPen = {"html":"&lt;p&gt;Double click to split. &lt;a id=&quot;keyboardUp&quot; href=&quot;#&quot;&gt;Increase&lt;/a&gt; / &lt;a id=&quot;keyboardDown&quot; href=&quot;#&quot;&gt;decrease&lt;/a&gt; size or &lt;a id=&quot;keyboardLeft&quot; href=&quot;#&quot;&gt;Previous&lt;/a&gt; / &lt;a id=&quot;keyboardRight&quot; href=&quot;#&quot;&gt;Next&lt;/a&gt; skin.&lt;/p&gt;\n&lt;canvas id=&#39;world&#39;&gt;&lt;/canvas&gt;","css":"body {\n    background-color: #333333;\n    padding: 0;\n    margin: 0;\n    overflow: hidden;\n}\np {\n    position: absolute;\n    z-index: 99;\n    color: #cccccc;\n    margin: 2px;\n    padding: 0;\n    font-family: Arial;\n    font-size: 10px;\n}\na { \n\t\tcolor: #f4f4f4;\n\t\tfont-weight: bold;\n}","js":"/**\n  * https://lab.hakim.se/blob/03/\n  */\nBlobWorld = new function () {\n\n  var SCREEN_WIDTH = window.innerWidth;\n  var SCREEN_HEIGHT = window.innerHeight;\n\n  var canvas;\n  var context;\n  var blobs = [];\n\n  var dragBlob;\n\n  var screenX = window.screenX;\n  var screenY = window.screenY;\n\n  var mouseX = window.innerWidth - SCREEN_WIDTH;\n  var mouseY = window.innerHeight - SCREEN_HEIGHT;\n  var mouseIsDown = false;\n  var mouseDownOffset = { x: 0, y: 0 };\n\n  // The bounds of the world\n  var worldRect = { x: 0, y: 0, width: 0, height: 0 };\n\n  // The world gravity, applied to all blobs\n  var gravity = { x: 0, y: 1.2 };\n\n  // A pair of blobs that should be merged\n  var mergeQueue = { blobA: -1, blobB: -1 };\n\n  var skinIndex = 0;\n  var skins = [\n  { fillStyle: &#39;rgba(0,200,250,1.0)&#39;, strokeStyle: &#39;#ffffff&#39;, lineWidth: 5, debug: false },\n  { fillStyle: &#39;&#39;, strokeStyle: &#39;&#39;, lineWidth: 0, debug: true },\n  { fillStyle: &#39;rgba(0,0,0,0.1)&#39;, strokeStyle: &#39;rgba(255,255,255,1.0)&#39;, lineWidth: 6, debug: false },\n  { fillStyle: &#39;rgba(0,230,110,1.0)&#39;, strokeStyle: &#39;rgba(0,0,0,1.0)&#39;, lineWidth: 2, debug: false },\n  { fillStyle: &#39;rgba(255,255,0,1.0)&#39;, strokeStyle: &#39;rgba(0,0,0,1.0)&#39;, lineWidth: 4, debug: false },\n  { fillStyle: &#39;rgba(255,255,255,1.0)&#39;, strokeStyle: &#39;rgba(0,0,0,1.0)&#39;, lineWidth: 4, debug: false }];\n\n\n  this.init = function () {\n\n    canvas = document.getElementById(&#39;world&#39;);\n\n    if (canvas &amp;&amp; canvas.getContext) {\n      context = canvas.getContext(&#39;2d&#39;);\n\n      // Register event listeners\n      window.addEventListener(&#39;mousemove&#39;, documentMouseMoveHandler, false);\n      canvas.addEventListener(&#39;mousedown&#39;, documentMouseDownHandler, false);\n      canvas.addEventListener(&#39;dblclick&#39;, documentDoubleClickHandler, false);\n      window.addEventListener(&#39;mouseup&#39;, documentMouseUpHandler, false);\n      document.addEventListener(&#39;touchstart&#39;, documentTouchStartHandler, false);\n      document.addEventListener(&#39;touchmove&#39;, documentTouchMoveHandler, false);\n      document.addEventListener(&#39;touchend&#39;, documentTouchEndHandler, false);\n      document.addEventListener(&#39;keydown&#39;, documentKeyDownHandler, false);\n      window.addEventListener(&#39;resize&#39;, windowResizeHandler, false);\n\n      document.getElementById(&#39;keyboardUp&#39;).addEventListener(&#39;click&#39;, keyboardUpHandler, false);\n      document.getElementById(&#39;keyboardDown&#39;).addEventListener(&#39;click&#39;, keyboardDownHandler, false);\n      document.getElementById(&#39;keyboardLeft&#39;).addEventListener(&#39;click&#39;, keyboardLeftHandler, false);\n      document.getElementById(&#39;keyboardRight&#39;).addEventListener(&#39;click&#39;, keyboardRightHandler, false);\n\n      createBlob({ x: SCREEN_WIDTH * 0.5, y: SCREEN_HEIGHT * 0.1 });\n\n      windowResizeHandler();\n\n      setInterval(loop, 1000 / 60);\n    }\n  };\n\n  function createBlob(position) {\n    var blob = new Blob();\n\n    blob.position.x = position.x;\n    blob.position.y = position.y;\n\n    blob.generateNodes();\n\n    blobs.push(blob);\n  }\n\n  function splitBlob(blob) {\n    if (blob.quality &gt; 8) {\n      blobs.push(blob.split());\n    }\n  }\n\n  function mergeBlobs(blobA, blobB) {\n    var t = getTime();\n\n    if (!blobs[blobA] || !blobs[blobB]) {\n      return;\n    }\n\n    if (t - blobs[blobA].lastSplitTime &gt; 500 &amp;&amp; t - blobs[blobB].lastSplitTime &gt; 500) {\n      // Merge blobB with blobA\n      blobs[blobA].merge(blobs[blobB]);\n\n      // Remove blobB since blobA will take over its body\n      blobs.splice(blobB, 1);\n    }\n  }\n\n  function documentMouseMoveHandler(event) {\n    mouseX = event.clientX - (window.innerWidth - SCREEN_WIDTH) * .5;\n    mouseY = event.clientY - (window.innerHeight - SCREEN_HEIGHT) * .5;\n  }\n\n  function documentMouseDownHandler(event) {\n    event.preventDefault();\n\n    mouseIsDown = true;\n\n    dragBlob = blobs[findClosestBody(blobs, { x: mouseX, y: mouseY })];\n    var closestNodeIndex = findClosestBody(dragBlob.nodes, { x: mouseX, y: mouseY });\n    dragBlob.dragNodeIndex = closestNodeIndex;\n\n    mouseDownOffset.y = 100;\n  }\n\n  function documentMouseUpHandler(event) {\n    mouseIsDown = false;\n\n    if (dragBlob) {\n      dragBlob.dragNodeIndex = -1;\n      dragBlob = null;\n    }\n  }\n\n  function documentTouchStartHandler(event) {\n    if (event.touches.length == 1) {\n      event.preventDefault();\n\n      mouseIsDown = true;\n\n      mouseX = event.touches[0].pageX - (window.innerWidth - SCREEN_WIDTH) * .5;\n      mouseY = event.touches[0].pageY - (window.innerHeight - SCREEN_HEIGHT) * .5;\n\n      dragBlob = blobs[findClosestBody(blobs, { x: mouseX, y: mouseY })];\n      var closestNodeIndex = findClosestBody(dragBlob.nodes, { x: mouseX, y: mouseY });\n      dragBlob.dragNodeIndex = closestNodeIndex;\n\n      mouseDownOffset.y = 100;\n    }\n  }\n\n  function documentTouchMoveHandler(event) {\n    if (event.touches.length == 1) {\n      event.preventDefault();\n\n      mouseX = event.touches[0].pageX - (window.innerWidth - SCREEN_WIDTH) * .5;\n      mouseY = event.touches[0].pageY - (window.innerHeight - SCREEN_HEIGHT) * .5;\n    }\n  }\n\n  function documentTouchEndHandler(event) {\n    mouseIsDown = false;\n\n    if (dragBlob) {\n      dragBlob.dragNodeIndex = -1;\n      dragBlob = null;\n    }\n  }\n\n  function documentDoubleClickHandler(event) {\n    var mouse = { x: mouseX, y: mouseY };\n\n    var blob = blobs[findClosestBody(blobs, mouse)];\n\n    if (distanceBetween(blob.position, mouse) &lt; blob.radius + 30) {\n      splitBlob(blob);\n    }\n  }\n\n  function documentKeyDownHandler(event) {\n    switch (event.keyCode) {\n      case 40:\n        changeBlobRadius(-10);\n        event.preventDefault();\n        break;\n      case 38:\n        changeBlobRadius(10);\n        event.preventDefault();\n        break;\n      case 37:\n        changeSkin(-1);\n        event.preventDefault();\n        break;\n      case 39:\n        changeSkin(1);\n        event.preventDefault();\n        break;}\n\n  }\n\n  function keyboardUpHandler(event) {\n    event.preventDefault();\n    changeBlobRadius(20);\n  }\n\n  function keyboardDownHandler(event) {\n    event.preventDefault();\n    changeBlobRadius(-20);\n  }\n\n  function keyboardLeftHandler(event) {\n    event.preventDefault();\n    changeSkin(-1);\n  }\n\n  function keyboardRightHandler(event) {\n    event.preventDefault();\n    changeSkin(1);\n  }\n\n  function changeSkin(offset) {\n    skinIndex += offset;\n    skinIndex = skinIndex &lt; 0 ? skins.length - 1 : skinIndex;\n    skinIndex = skinIndex &gt; skins.length - 1 ? 0 : skinIndex;\n  }\n\n  function changeBlobRadius(offset) {\n    for (var i = 0, len = blobs.length; i &lt; len; i++) {\n      blob = blobs[i];\n\n      var oldRadius = blob.radius;\n\n      blob.radius += offset;\n      blob.radius = Math.max(40, Math.min(blob.radius, 280));\n\n      if (blob.radius != oldRadius) {\n        blob.updateNormals();\n      }\n    }\n  }\n\n  function findClosestBody(bodies, position) {\n    var closestDistance = 9999;\n    var currentDistance = 9999;\n    var closestIndex = -1;\n\n    for (var i = 0, len = bodies.length; i &lt; len; i++) {\n      var body = bodies[i];\n\n      currentDistance = distanceBetween(body.position, { x: position.x, y: position.y });\n\n      if (currentDistance &lt; closestDistance) {\n        closestDistance = currentDistance;\n        closestIndex = i;\n      }\n    }\n\n    return closestIndex;\n  }\n\n  function windowResizeHandler() {\n    SCREEN_WIDTH = window.innerWidth;\n    SCREEN_HEIGHT = window.innerHeight;\n\n    canvas.width = SCREEN_WIDTH;\n    canvas.height = SCREEN_HEIGHT;\n\n    worldRect.x = 3;\n    worldRect.y = 3;\n    worldRect.width = SCREEN_WIDTH - 6;\n    worldRect.height = SCREEN_HEIGHT - 6;\n  }\n\n  function loop() {\n\n    var skin = skins[skinIndex];\n\n    // The area around the dirty region to include in the clear\n    var dirtySpread = 80;\n\n    var u1, u2, ulen, blob;\n\n    // Clear the dirty rects of all blobs\n    for (u1 = 0, ulen = blobs.length; u1 &lt; ulen; u1++) {\n      blob = blobs[u1];\n\n      // Clear all pixels in the dirty region\n      context.clearRect(blob.dirtyRegion.left - dirtySpread, blob.dirtyRegion.top - dirtySpread, blob.dirtyRegion.right - blob.dirtyRegion.left + dirtySpread * 2, blob.dirtyRegion.bottom - blob.dirtyRegion.top + dirtySpread * 2);\n\n      // Reset the dirty region so that it can be expanded anew\n      blob.dirtyRegion = { left: worldRect.x + worldRect.width, top: worldRect.y + worldRect.height, right: 0, bottom: 0 };\n    }\n\n    // If there is a merge queued, solve it now\n    if (mergeQueue.blobA != -1 &amp;&amp; mergeQueue.blobB != -1) {\n      mergeBlobs(mergeQueue.blobA, mergeQueue.blobB);\n\n      mergeQueue.blobA = -1;\n      mergeQueue.blobB = -1;\n    }\n\n    // If the mouse is down, start adding the velocity needed to move towards the mouse position\n    if (dragBlob) {\n      dragBlob.velocity.x += (mouseX + mouseDownOffset.x - dragBlob.position.x) * 0.01;\n      dragBlob.velocity.y += (mouseY + mouseDownOffset.y - dragBlob.position.y) * 0.01;\n    }\n\n    for (u1 = 0, ulen = blobs.length; u1 &lt; ulen; u1++) {\n      blob = blobs[u1];\n\n      for (u2 = 0; u2 &lt; ulen; u2++) {\n        var otherBlob = blobs[u2];\n\n        if (otherBlob != blob) {\n          var distance = distanceBetween({ x: blob.position.x, y: blob.position.y }, { x: otherBlob.position.x, y: otherBlob.position.y });\n\n          if (distance &lt; blob.radius + otherBlob.radius) {\n            mergeQueue.blobA = u1;\n            mergeQueue.blobB = u2;\n          }\n        }\n      }\n\n      // Track window movement\n      blob.velocity.x += (window.screenX - screenX) * (0.04 + Math.random() * 0.1);\n      blob.velocity.y += (window.screenY - screenY) * (0.04 + Math.random() * 0.1);\n\n      var friction = { x: 1.035, y: 1.035 };\n\n      // Enforce horizontal world bounds\n      if (blob.position.x &gt; worldRect.x + worldRect.width) {\n        blob.velocity.x -= (blob.position.x - worldRect.width) * 0.05;\n        friction.y = 1.07;\n      } else\n      if (blob.position.x &lt; worldRect.x) {\n        blob.velocity.x += Math.abs(worldRect.x - blob.position.x) * 0.05;\n        friction.y = 1.07;\n      }\n\n      // Enforce vertical world bounds\n      if (blob.position.y &gt; worldRect.y + worldRect.height) {\n        blob.velocity.y -= (blob.position.y - worldRect.height) * 0.05;\n        friction.x = 1.07;\n      } else\n      if (blob.position.y &lt; worldRect.y) {\n        blob.velocity.y += Math.abs(worldRect.y - blob.position.y) * 0.05;\n        friction.x = 1.07;\n      }\n\n      // Gravity\n      blob.velocity.x += gravity.x;\n      blob.velocity.y += gravity.y;\n\n      // Friction\n      blob.velocity.x /= friction.x;\n      blob.velocity.y /= friction.y;\n\n      // Apply the velocity to the entire blob\n      blob.position.x += blob.velocity.x;\n      blob.position.y += blob.velocity.y;\n\n      var i, j, len, node, joint, position;\n\n      // Update all node ghosts (previous positions). All nodes need to be synced before the below\n      // calculation loop to avoid tearing between the first nodes\n      for (i = 0, len = blob.nodes.length; i &lt; len; i++) {\n        node = blob.nodes[i];\n\n        node.ghost.x = node.position.x;\n        node.ghost.y = node.position.y;\n      }\n\n      var dragNode = blob.nodes[blob.dragNodeIndex];\n      if (dragNode) {\n        var angle = Math.atan2(mouseY - (blob.position.y - 80), mouseX - blob.position.x);\n\n        blob.rotation += (angle - blob.rotation) * 0.03;\n        blob.updateNormals();\n      }\n\n      // Calculation loop\n      for (i = 0, len = blob.nodes.length; i &lt; len; i++) {\n        node = blob.nodes[i];\n\n        // Move towards the normal target\n        node.normal.x += (node.normalTarget.x - node.normal.x) * 0.05;\n        node.normal.y += (node.normalTarget.y - node.normal.y) * 0.05;\n\n        // This point will be used as the new position for this node, after all factors have been applied\n        position = { x: blob.position.x, y: blob.position.y };\n\n        // Apply the joints\n        for (j = 0; j &lt; node.joints.length; j++) {\n          joint = node.joints[j];\n\n          // Determine the strain on the joints\n          var strainX = joint.node.ghost.x - node.ghost.x - (joint.node.normal.x - node.normal.x);\n          var strainY = joint.node.ghost.y - node.ghost.y - (joint.node.normal.y - node.normal.y);\n\n          position.x += strainX * joint.strength;\n          position.y += strainY * joint.strength;\n        }\n\n        // Offset by the normal\n        position.x += node.normal.x;\n        position.y += node.normal.y;\n\n        // Apply the drag offset (if applicable)\n        if (i == blob.dragNodeIndex) {\n          position.x += (mouseX - position.x) * 0.98;\n          position.y += (mouseY - position.y) * 0.98;\n        }\n\n        // Apply the calculated position to the node (with easing)\n        node.position.x += (position.x - node.position.x) * 0.1;\n        node.position.y += (position.y - node.position.y) * 0.1;\n\n        // Limit the node position to screen bounds\n        node.position.x = Math.max(Math.min(node.position.x, worldRect.x + worldRect.width), worldRect.x);\n        node.position.y = Math.max(Math.min(node.position.y, worldRect.y + worldRect.height), worldRect.y);\n\n        // Expand the dirty rect if needed\n        blob.dirtyRegion.left = Math.min(blob.dirtyRegion.left, node.position.x);\n        blob.dirtyRegion.top = Math.min(blob.dirtyRegion.top, node.position.y);\n        blob.dirtyRegion.right = Math.max(blob.dirtyRegion.right, node.position.x);\n        blob.dirtyRegion.bottom = Math.max(blob.dirtyRegion.bottom, node.position.y);\n      }\n\n      if (!skin.debug) {\n        context.beginPath();\n        context.fillStyle = skin.fillStyle;\n        context.strokeStyle = skin.strokeStyle;\n        context.lineWidth = skin.lineWidth;\n      }\n\n      var cn = getArrayElementByOffset(blob.nodes, 0, -1); // current node\n      var nn = getArrayElementByOffset(blob.nodes, 0, 0); // next node\n\n      // Move to the first anchor\n      context.moveTo(cn.position.x + (nn.position.x - cn.position.x) / 2, cn.position.y + (nn.position.y - cn.position.y) / 2);\n\n      // Rendering loop\n      for (i = 0, len = blob.nodes.length; i &lt; len; i++) {\n        cn = getArrayElementByOffset(blob.nodes, i, 0);\n        nn = getArrayElementByOffset(blob.nodes, i, 1);\n\n        if (skin.debug) {\n          context.beginPath();\n          context.lineWidth = 1;\n          context.strokeStyle = &quot;#ababab&quot;;\n\n          for (j = 0; j &lt; cn.joints.length; j++) {\n            joint = cn.joints[j];\n            context.moveTo(cn.position.x, cn.position.y);\n            context.lineTo(joint.node.position.x, joint.node.position.y);\n          }\n\n          context.stroke();\n\n          context.beginPath();\n          context.fillStyle = i == 0 ? &quot;#00ff00&quot; : &quot;#dddddd&quot;;\n          context.arc(cn.position.x, cn.position.y, 5, 0, Math.PI * 2, true);\n          context.fill();\n        } else\n        {\n          context.quadraticCurveTo(cn.position.x, cn.position.y, cn.position.x + (nn.position.x - cn.position.x) / 2, cn.position.y + (nn.position.y - cn.position.y) / 2);\n        }\n      }\n\n      if (skin.debug) {\n        //        context.beginPath();\n        //        context.fillStyle = &quot;rgba(100,255,100,0.3)&quot;;\n        //        context.fillRect(blob.dirtyRegion.left-dirtySpread,blob.dirtyRegion.top-dirtySpread,blob.dirtyRegion.right-blob.dirtyRegion.left+(dirtySpread*2),blob.dirtyRegion.bottom-blob.dirtyRegion.top+(dirtySpread*2));\n        //        context.fill();\n      }\n\n      context.stroke();\n      context.fill();\n    }\n\n    screenX = window.screenX;\n    screenY = window.screenY;\n  }\n\n\n}();\n\nfunction Blob() {\n  this.position = { x: 0, y: 0 };\n  this.velocity = { x: 0, y: 0 };\n  this.radius = 120;\n  this.quality = 32;\n  this.nodes = [];\n  this.rotation = -Math.PI * 0.5;\n  this.dragNodeIndex = -1;\n  this.dirtyRegion = { left: 0, top: 0, right: 0, bottom: 0 };\n  this.lastSplitTime = 0;\n\n  this.generateNodes = function () {\n    this.nodes = [];\n\n    var i, n;\n\n    for (i = 0; i &lt; this.quality; i++) {\n      n = {\n        normal: { x: 0, y: 0 },\n        normalTarget: { x: 0, y: 0 },\n        position: { x: this.position.x, y: this.position.y },\n        ghost: { x: this.position.x, y: this.position.y },\n        angle: 0 };\n\n\n      this.nodes.push(n);\n    }\n\n    this.updateJoints();\n\n    this.updateNormals();\n  };\n\n  this.updateJoints = function () {\n    for (var i = 0; i &lt; this.quality; i++) {\n      var n = this.nodes[i];\n\n      n.joints = [\n      {\n        node: getArrayElementByOffset(this.nodes, i, -1),\n        strength: 2.2 },\n\n      {\n        node: getArrayElementByOffset(this.nodes, i, 1),\n        strength: 2.2 }];\n\n\n\n      n.joints.push({\n        node: getArrayElementByOffset(this.nodes, i, -2),\n        strength: 2.2 });\n\n\n      n.joints.push({\n        node: getArrayElementByOffset(this.nodes, i, 2),\n        strength: 2.2 });\n\n\n    }\n  };\n\n  this.updateNormals = function () {\n    var i, j, n;\n\n    for (i = 0; i &lt; this.quality; i++) {\n\n      var n = this.nodes[i];\n\n      if (this.dragNodeIndex != -1) {\n        j = i - this.dragNodeIndex;\n        j = j &lt; 0 ? this.quality + j : j;\n      } else\n      {\n        j = i;\n      }\n\n      n.angle = j / this.quality * Math.PI * 2 + this.rotation;\n\n      n.normalTarget.x = Math.cos(n.angle) * this.radius;\n      n.normalTarget.y = Math.sin(n.angle) * this.radius;\n\n      if (n.normal.x == 0 &amp;&amp; n.normal.y == 0) {\n        n.normal.x = n.normalTarget.x;\n        n.normal.y = n.normalTarget.y;\n      }\n    }\n  };\n\n  this.split = function () {\n\n    var velocitySpread = this.radius / 10;\n    var nodeSpread = Math.round(this.nodes.length * 0.5);\n    var radiusSpread = this.radius * 0.5;\n\n    var sibling = new Blob();\n\n    sibling.position.x = this.position.x;\n    sibling.position.y = this.position.y;\n\n    sibling.velocity.x = velocitySpread;\n    sibling.velocity.y = this.velocity.y;\n\n    sibling.nodes = [];\n\n    var i = 0;\n    while (i++ &lt; nodeSpread) {\n      sibling.nodes.push(this.nodes.shift());\n    }\n\n    sibling.radius = radiusSpread;\n    sibling.quality = sibling.nodes.length;\n\n    this.velocity.x = -velocitySpread;\n    this.radius = radiusSpread;\n    this.quality = this.nodes.length;\n\n    this.dragNodeIndex = -1;\n    this.updateJoints();\n    this.updateNormals();\n\n    sibling.dragNodeIndex = -1;\n    sibling.updateJoints();\n    sibling.updateNormals();\n\n    sibling.lastSplitTime = getTime();\n    this.lastSplitTime = getTime();\n\n    return sibling;\n\n  };\n\n  this.merge = function (sibling) {\n    this.velocity.x *= 0.5;\n    this.velocity.y *= 0.5;\n\n    this.velocity.x += sibling.velocity.x * 0.5;\n    this.velocity.y += sibling.velocity.y * 0.5;\n\n    while (sibling.nodes.length) {\n      this.nodes.push(sibling.nodes.shift());\n    }\n\n    this.quality = this.nodes.length;\n    this.radius += sibling.radius;\n\n    this.dragNodeIndex = -1;\n\n    this.updateNormals();\n    this.organizeNodesByProximity();\n    this.updateJoints();\n  };\n\n  this.organizeNodesByProximity = function () {\n    var i, j, outer, inner;\n\n    var closestDistance, currentDistance, closestIndex;\n\n    var newNodes = this.nodes.concat();\n    var blackListed = [];\n\n    for (i = 0; i &lt; this.quality; i++) {\n      outer = newNodes[i];\n\n      currentDistance = 9999;\n      closestDistance = 9999;\n      closestIndex = -1;\n\n      for (j = 0; j &lt; this.quality; j++) {\n        inner = newNodes[j];\n\n        currentDistance = distanceBetween(inner.position, outer.position);\n\n        if (currentDistance &lt; closestDistance &amp;&amp; blackListed.indexOf(inner) === -1) {\n          closestDistance = currentDistance;\n          closestIndex = j;\n        }\n      }\n\n      this.nodes[i] = newNodes[closestIndex];\n    }\n\n  };\n}\n\nfunction getArrayElementByOffset(array, index, offset) {\n  if (array[index + offset]) {\n    return array[index + offset];\n  }\n\n  if (index + offset &gt; array.length - 1) {\n    return array[index - array.length + offset];\n  }\n\n  if (index + offset &lt; 0) {\n    return array[array.length + (index + offset)];\n  }\n}\n\nfunction sortByField(list, field) {\n  var sortOnField = function (a, b) {\n    return a[field] - b[field];\n  };\n\n  list.sort(sortOnField);\n}\n\nfunction getTime() {\n  return new Date().getTime();\n}\n\nfunction distanceBetween(p1, p2) {\n  var dx = p2.x - p1.x;\n  var dy = p2.y - p1.y;\n  return Math.sqrt(dx * dx + dy * dy);\n}\n\n\nBlobWorld.init();"};
    __preprocessors = {
      "html": "none",
      "css": "none",
      "js": "none"
    };
    __preprocessorNames = {
      "html": "HTML",
      "css": "CSS",
      "js": "JS"
    };
    __editable = false;
    __embed_prefill = false;
  </script>
<script src="./embed-59842fbf0495f2c0b079a7f4ce7544fb0912f3535856bf4dc5c205acbb621c54.js"></script>


</body></html>